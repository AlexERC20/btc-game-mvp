<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Real Price BTC Game</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root{
    --bg:#000; --text:#fff; --muted:#b9b9b9; --ring:#ff8c00;
    --green:#1fa36a; --red:#c6423a; --card:#0b0b0b; --border:#1e1e1e; --chip:#121212;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial}
  .wrap{max-width:520px;margin:0 auto;padding:16px 14px 28px}
  .price{font-size:24px;font-weight:800;text-align:center;margin-top:2px}
  .sub{font-size:12px;color:var(--muted);text-align:center;margin:2px 0 8px}
  .balance{text-align:center;font-size:16px;margin:4px 0 8px}
  .center{display:flex;justify-content:center;align-items:center;margin:8px 0}
  .timer{position:relative;width:300px;height:300px}
  .timer svg{width:100%;height:100%;display:block;transform:rotate(-90deg)}
  .t{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:44px;font-weight:800}
  .phase{text-align:center;color:var(--muted);margin-top:10px}
  .bank{text-align:center;color:#fff;font-size:18px;margin-top:6px}
  .row{display:flex;gap:14px;justify-content:center;margin:12px 0}
  .btn{flex:1;border:none;border-radius:16px;padding:14px 0;color:#fff;font-size:20px;font-weight:800;cursor:pointer}
  .btn:active{transform:translateY(1px) scale(.99)}
  .btn[disabled]{opacity:.5;cursor:not-allowed;pointer-events:none} /* блок кликов, когда disabled */
  .buy{background:var(--green)} .sell{background:var(--red)}

  .menu{display:flex;gap:10px;justify-content:center;margin:8px 0 10px;flex-wrap:wrap}
  .chipbtn{background:#121212;border:1px solid var(--border);border-radius:999px;padding:8px 12px;font-size:13px;color:#fff;cursor:pointer}

  .history{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:4px 0 10px}
  .chip{background:var(--chip);border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;display:flex;gap:6px;align-items:center}
  .up{color:#5ad19c}.down{color:#ff6b6b}

  .head{color:var(--muted);font-size:13px;margin:10px 0 6px;text-align:center}
  .lb{display:grid;grid-template-columns:1fr;gap:8px}
  .rank{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px 12px;display:flex;justify-content:space-between;align-items:center}
  .rank .left{display:flex;gap:8px;align-items:center}
  .badge{width:24px;height:24px;border-radius:999px;background:#222;display:flex;align-items:center;justify-content:center;font-weight:800}

  /* bottom sheets */
  .sheet-backdrop{position:fixed;inset:0;background:#0008;opacity:0;pointer-events:none;transition:.2s}
  .sheet-backdrop.show{opacity:1;pointer-events:auto}
  .sheet{position:fixed;left:0;right:0;bottom:-60%;background:#0b0b0b;border-top:1px solid var(--border);
         border-radius:16px 16px 0 0;padding:14px 14px 18px;transition:.25s}
  .sheet.open{bottom:0}
  .sheet h3{margin:6px 0 10px;font-size:16px}
  .rowchips{display:flex;gap:8px;flex-wrap:wrap}
  .chipopt{background:#121212;border:1px solid var(--border);border-radius:999px;padding:8px 12px;font-size:13px;cursor:pointer}
  .chipopt.active{outline:2px solid var(--ring)}
  .inputline{display:flex;gap:8px;margin:10px 0}
  .inputline input{flex:1;background:#121212;border:1px solid var(--border);border-radius:10px;
                   padding:10px;color:#fff;font-size:14px}
  .switchline{display:flex;justify-content:space-between;align-items:center;margin:8px 0;color:#ddd}
  .sheet .btnrow{display:flex;gap:10px;margin-top:10px}
  .sheet .btnrow .btnsm{flex:1;background:var(--green);border:none;border-radius:12px;color:#fff;padding:10px 0;font-weight:700}
  .sheet .btnrow .btnsm.cancel{background:#333}
  .sheet p{color:#ddd;font-size:13px;line-height:1.35;margin:6px 0}
</style>
</head>
<body>
<div class="wrap">
  <div class="price" id="price">$—</div>
  <div class="sub"   id="sub">Старт: —</div>
  <div class="balance" id="bal">Баланс: $—</div>

  <div class="center">
    <div class="timer">
      <svg viewBox="0 0 320 320" preserveAspectRatio="xMidYMid meet">
        <circle cx="160" cy="160" r="140" stroke="#1f1f1f" stroke-width="14" fill="none"/>
        <circle id="ring" cx="160" cy="160" r="140" stroke="var(--ring)" stroke-width="14" fill="none"
                stroke-linecap="round" stroke-dasharray="879.645" stroke-dashoffset="0"/>
      </svg>
      <div class="t" id="tleft">00:60</div>
    </div>
  </div>

  <div class="phase" id="phase">Ставки открыты</div>
  <div class="bank" id="bank">Банк: $0</div>

  <div class="row">
    <button class="btn buy" id="buy">↑ BUY</button>
    <button class="btn sell" id="sell">↓ SELL</button>
  </div>

  <!-- меню: БЕЗ кнопки "Проверить" -->
  <div class="menu">
    <button class="chipbtn" id="cfgBtn">⚙️ Ставка</button>
    <button class="chipbtn" id="refBtn">Рефералы</button>
    <button class="chipbtn" id="topupBtn">Пополнение</button>
    <button class="chipbtn" id="insBtn">Страховки</button>
    <button class="chipbtn" id="starsBtn">Купить ⭐</button>
  </div>

  <div class="history" id="hist"></div>

  <div class="head">Топ победителей за час</div>
  <div class="lb" id="lb"></div>
</div>

<!-- Backdrop -->
<div class="sheet-backdrop" id="sheetBg"></div>

<!-- SHEET: настройки ставки -->
<div class="sheet" id="sheetStake">
  <h3>Сумма ставки</h3>
  <div class="rowchips" id="chips">
    <button class="chipopt" data-v="50">$50</button>
    <button class="chipopt" data-v="100">$100</button>
    <button class="chipopt" data-v="250">$250</button>
    <button class="chipopt" data-v="500">$500</button>
    <button class="chipopt" data-v="1000">$1000</button>
  </div>
  <div class="inputline">
    <input id="customAmt" type="number" min="50" step="1" placeholder="Другая сумма, $ (≥50)">
  </div>
  <div class="switchline">
    <span>Ставить в 1 клик (без подтверждения)</span>
    <label><input type="checkbox" id="oneClick"></label>
  </div>
  <div class="btnrow">
    <button class="btnsm cancel" data-close>Отмена</button>
    <button class="btnsm" id="cfgSave">Сохранить</button>
  </div>
</div>

<!-- SHEET: пополнение (подписка/проверка/ежедневка/реф) -->
<div class="sheet" id="sheetTopup">
  <h3>Пополнение баланса</h3>
  <p>• +$5000 — за подписку на канал @erc20coin (один раз)</p>
  <p>• +$1000 — за ежедневный вход</p>
  <p>• +$500 — за каждого друга по реф-ссылке</p>
  <div class="btnrow">
    <button class="btnsm" id="openChannel">Открыть канал</button>
    <button class="btnsm" id="checkBonus">Проверить</button>
  </div>
  <div class="btnrow">
    <button class="btnsm cancel" data-close>Закрыть</button>
  </div>
</div>

<!-- SHEET: покупка Stars -->
<div class="sheet" id="sheetStars">
  <h3>Купить звёзды ⭐</h3>
  <p>Выбери пакет, оплати в Telegram Stars — баланс обновится автоматически.</p>
  <div class="rowchips" id="starsPacks">
    <button class="chipopt" data-pack="100">100⭐ → $3 000</button>
    <button class="chipopt" data-pack="500">500⭐ → $16 000</button>
    <button class="chipopt" data-pack="1000">1000⭐ → $35 000</button>
    <button class="chipopt" data-pack="10000">10000⭐ → $400 000</button>
    <button class="chipopt" data-pack="30000">30000⭐ → $1 500 000</button>
  </div>
  <div class="btnrow">
    <button class="btnsm cancel" data-close>Отмена</button>
    <button class="btnsm" id="buyStars">Оплатить</button>
  </div>
</div>

<!-- SHEET: страховки -->
<div class="sheet" id="sheetIns">
  <h3>Страховки</h3>
  <p>Возвращают 50% от суммы проигрыша</p>
  <p>1000⭐ → 100 страховок</p>
  <p id="insCount">Доступно: 0</p>
  <div class="btnrow">
    <button class="btnsm cancel" data-close>Закрыть</button>
    <button class="btnsm" id="buyIns">Купить за ⭐</button>
  </div>
</div>

<script>
const qs = new URLSearchParams(location.search);
const uid = qs.get('uid')
  || (window.Telegram?.WebApp?.initDataUnsafe?.user?.id)
  || prompt('Введите ваш Telegram ID для теста:');

const username = (window.Telegram?.WebApp?.initDataUnsafe?.user?.username)
  ? '@' + window.Telegram.WebApp.initDataUnsafe.user.username
  : null;

// === УКАЖИ ИМЯ СВОЕГО БОТА (без @) ===
const BOT_USERNAME = 'realpricebtc_bot';
const CHANNEL_LINK = 'https://t.me/erc20coin';

if (window.Telegram && Telegram.WebApp) { try { Telegram.WebApp.expand(); } catch(e){} }

let CURRENT_PHASE = 'idle'; // <-- глобально храним текущую фазу
let INS_COUNT = 0;

// elements
const priceEl = document.getElementById('price');
const subEl   = document.getElementById('sub');
const balEl   = document.getElementById('bal');
const ring    = document.getElementById('ring');
const tleft   = document.getElementById('tleft');
const phaseEl = document.getElementById('phase');
const bankEl  = document.getElementById('bank');
const buyBtn  = document.getElementById('buy');
const sellBtn = document.getElementById('sell');
const histEl  = document.getElementById('hist');
const lbEl    = document.getElementById('lb');

const refBtn  = document.getElementById('refBtn');
const topupBtn= document.getElementById('topupBtn');
const starsBtn= document.getElementById('starsBtn');
const insBtn  = document.getElementById('insBtn');
const cfgBtn  = document.getElementById('cfgBtn');

// sheets
const sheetBg     = document.getElementById('sheetBg');
const sheetStake  = document.getElementById('sheetStake');
const sheetTopup  = document.getElementById('sheetTopup');
const sheetStars  = document.getElementById('sheetStars');
const sheetIns    = document.getElementById('sheetIns');

// stake controls
const chipsBox  = document.getElementById('chips');
const customAmt = document.getElementById('customAmt');
const oneClick  = document.getElementById('oneClick');
const cfgSave   = document.getElementById('cfgSave');

// topup controls
const openChannel = document.getElementById('openChannel');
const checkBonus  = document.getElementById('checkBonus');

// stars controls
const starsPacks = document.getElementById('starsPacks');
const buyStars   = document.getElementById('buyStars');
const insCountEl = document.getElementById('insCount');
const buyIns     = document.getElementById('buyIns');

const CIRC = 2*Math.PI*140;
ring.setAttribute('stroke-dasharray', CIRC);

// helpers
function fmt(n){ return '$'+Number(n||0).toLocaleString(); }
function phaseText(p){
  if (p==='betting') return 'Ставки открыты';
  if (p==='locked')  return 'Ставки закрыты';
  if (p==='pause')   return 'Пауза';
  return 'Ожидание';
}
function chip(h){
  const dir = h.side==='BUY'?'↑ BUY':'↓ SELL';
  const cls = h.side==='BUY'?'up':'down';
  const pct = (h.pct>0?'+':'') + h.pct.toFixed(2) + '%';
  return `<div class="chip"><span class="${cls}">${dir}</span><span class="${cls}">${pct}</span><span>${fmt(h.win)}</span></div>`;
}

// sheet helpers
function openSheet(el){ el.classList.add('open'); sheetBg.classList.add('show'); }
function closeAllSheets(){
  [sheetStake, sheetTopup, sheetStars, sheetIns].forEach(s=>s.classList.remove('open'));
  sheetBg.classList.remove('show');
}
sheetBg.addEventListener('click', closeAllSheets);
document.querySelectorAll('[data-close]').forEach(btn=>btn.addEventListener('click', closeAllSheets));

// settings storage
function getSettings(){
  return {
    amount: Math.max(50, Number(localStorage.getItem('bet_amount')||100) || 100),
    oneClick: localStorage.getItem('bet_oneclick') === '1'
  };
}
function setSettings(s){
  localStorage.setItem('bet_amount', String(Math.max(50, s.amount||100)));
  localStorage.setItem('bet_oneclick', s.oneClick ? '1' : '0');
}
function highlightChips(val){
  document.querySelectorAll('#chips .chipopt').forEach(b=>{
    b.classList.toggle('active', Number(b.dataset.v)===Number(val));
  });
}

// api
async function auth(){
  const r = await fetch('/api/auth',{
    method:'POST', headers:{'Content-Type':'application/json'},
    body:JSON.stringify({uid, username})
  }).then(r=>r.json()).catch(()=>({ok:false}));
  if (r.ok) {
    balEl.textContent = 'Баланс: ' + fmt(r.user.balance);
    INS_COUNT = Number(r.user.insurance || 0);
    if (insCountEl) insCountEl.textContent = 'Доступно: ' + INS_COUNT;
  }
}
async function refreshBalance(){
  const r = await fetch('/api/auth',{
    method:'POST', headers:{'Content-Type':'application/json'},
    body:JSON.stringify({uid, username})
  }).then(r=>r.json()).catch(()=>({ok:false}));
  if (r.ok) {
    balEl.textContent = 'Баланс: ' + fmt(r.user.balance);
    INS_COUNT = Number(r.user.insurance || 0);
    if (insCountEl) insCountEl.textContent = 'Доступно: ' + INS_COUNT;
  }
}
async function leaderboard(){
  const r = await fetch('/api/leaderboard').then(r=>r.json()).catch(()=>({ok:false}));
  if (!r.ok) return;
  lbEl.innerHTML = (r.top||[]).map((x,i)=>`
    <div class="rank">
      <div class="left">
        <div class="badge">${i+1}</div>
        <div class="name">${x.name}</div>
      </div>
      <div class="val">${fmt(x.won)}</div>
    </div>
  `).join('') || '<div class="rank"><div class="left"><div class="badge">—</div><div class="name">ещё пусто</div></div><div class="val">$0</div></div>';
}

// polling
async function poll(){
  const r = await fetch('/api/round').then(r=>r.json()).catch(()=>null);
  if (!r) return;

  if (r.price){
    priceEl.textContent = fmt(r.price);
    if (r.startPrice){
      priceEl.style.color = r.price>r.startPrice?'#1fa36a':(r.price<r.startPrice?'#c6423a':'#fff');
      subEl.textContent = 'Старт: ' + Math.round(r.startPrice);
    }
  }

  tleft.textContent = '00:' + String(Math.max(r.secsLeft||0,0)).padStart(2,'0');
  const len = r.roundLen||60;
  const progress = Math.max(0, Math.min(1, (len - (r.secsLeft||0))/len));
  ring.style.transition='stroke-dashoffset .5s linear';
  ring.setAttribute('stroke-dashoffset', CIRC*progress);

  CURRENT_PHASE = r.phase || 'idle';         // фиксируем текущую фазу
  phaseEl.textContent = phaseText(CURRENT_PHASE);
  bankEl.textContent  = 'Банк: ' + fmt(r.bank);

  const open = CURRENT_PHASE === 'betting';  // только в betting — активны кнопки
  buyBtn.disabled  = !open;
  sellBtn.disabled = !open;

  const h = await fetch('/api/history').then(r=>r.json()).catch(()=>({history:[]}));
  histEl.innerHTML = (h.history||[]).map(chip).join('');

  await refreshBalance();
  await leaderboard();
}

// действия ставок
async function place(side){
  // защита от кликов вне окна ставок
  if (CURRENT_PHASE !== 'betting') {
    alert('Окно ставок закрыто');
    return;
  }

  const s = getSettings();
  let amount = s.amount;

  if (!s.oneClick){
    const val = prompt('Сумма ставки ($):', String(amount));
    if (val === null) return;
    amount = parseInt(val,10);
    if (!amount || amount<=0) return alert('Введи положительную сумму');
  }
  if (amount < 50){ alert('Минимальная ставка $50'); return; }

  const r = await fetch('/api/bet',{
    method:'POST', headers:{'Content-Type':'application/json'},
    body:JSON.stringify({uid, side, amount})
  }).then(r=>r.json()).catch(()=>({ok:false,error:'SERVER'}));

  if (!r.ok) {
    const msg =
      r.error==='BETTING_CLOSED' ? 'Окно ставок закрыто' :
      r.error==='INSUFFICIENT_BALANCE' ? 'Недостаточно средств' :
      r.error?.startsWith?.('MIN_BET_') ? `Минимальная ставка: $${r.error.split('_').pop()}` :
      'Ошибка: '+(r.error||'UNKNOWN');
    alert(msg);
    return;
  }
  if (r.placed) setSettings({ amount: r.placed, oneClick: s.oneClick });
  await poll();
}
buyBtn.onclick = ()=> place('BUY');
sellBtn.onclick = ()=> place('SELL');

// открыть листы
cfgBtn.onclick   = ()=>{ highlightChips(getSettings().amount); customAmt.value=''; oneClick.checked=getSettings().oneClick; openSheet(sheetStake); };
topupBtn.onclick = ()=> openSheet(sheetTopup);
insBtn.onclick  = ()=>{ insCountEl.textContent = 'Доступно: ' + INS_COUNT; openSheet(sheetIns); };
starsBtn.onclick = ()=> openSheet(sheetStars);

// stake sheet handlers
chipsBox.addEventListener('click', (e)=>{
  const b = e.target.closest('.chipopt'); if (!b) return;
  document.querySelectorAll('#chips .chipopt').forEach(x=>x.classList.remove('active'));
  b.classList.add('active'); customAmt.value='';
});
cfgSave.onclick = ()=>{
  let val = Number(customAmt.value || 0);
  if (!val){
    const active = document.querySelector('#chips .chipopt.active');
    val = active ? Number(active.dataset.v) : getSettings().amount;
  }
  if (val < 50) { alert('Минимальная ставка $50'); return; }
  setSettings({ amount: Math.floor(val), oneClick: oneClick.checked });
  closeAllSheets();
  alert('Сохранено: $' + Math.floor(val) + (oneClick.checked ? ' • 1-клик' : ''));
};

// topup sheet handlers
openChannel.onclick = ()=>{
  try{
    if (window.Telegram?.WebApp?.openTelegramLink) Telegram.WebApp.openTelegramLink(CHANNEL_LINK);
    else window.location.href = CHANNEL_LINK;
  }catch(e){ window.location.href = CHANNEL_LINK; }
};
// новая проверка без редиректа — дергаем ваш API
checkBonus.onclick = async ()=>{
  const r = await fetch('/api/bonus/check', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ uid })
  }).then(r=>r.json()).catch(()=>({ ok:false }));

  if (!r.ok) { alert('Не удалось проверить бонус.'); return; }

  if (r.added > 0) {
    await refreshBalance();
    alert('Начислено: $' + Number(r.added).toLocaleString());
  } else {
    alert(r.msg || 'Пока ничего не начислено.');
  }
  closeAllSheets();
};

// рефералы
refBtn.onclick = ()=>{
  const link = `https://t.me/${BOT_USERNAME}?start=${uid}`;
  if (navigator.share){
    navigator.share({ title:'BTC Game', text:'Залетай в игру!', url:link }).catch(()=>{});
  } else {
    alert('Твоя реф-ссылка:\n' + link + '\nЗа каждого друга +$500 после его первого входа.');
  }
};

// Stars: выбор пакета и оплата
let selectedPack = null;
starsPacks.addEventListener('click', (e)=>{
  const b = e.target.closest('.chipopt'); if (!b) return;
  document.querySelectorAll('#starsPacks .chipopt').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  selectedPack = b.dataset.pack;
});
buyStars.onclick = async ()=>{
  const pack = selectedPack || '100';
  const resp = await fetch('/api/stars/create', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ uid, pack })
  }).then(r=>r.json()).catch(()=>({ ok:false }));
  if (!resp.ok) { alert('Не удалось создать платёж.'); return; }

  const open = Telegram?.WebApp?.openInvoice?.(resp.link, async (status) => {
    if (status === 'paid') {
      await refreshBalance();
      alert('Оплата успешна! Баланс обновлён.');
    } else if (status === 'cancelled') {
      alert('Платёж отменён');
    } else if (status === 'failed') {
      alert('Платёж не прошёл');
    }
  });
  try { await open; await refreshBalance(); } catch {}
  closeAllSheets();
};

buyIns.onclick = async ()=>{
  const resp = await fetch('/api/insurance/create', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ uid })
  }).then(r=>r.json()).catch(()=>({ ok:false }));
  if (!resp.ok) { alert('Не удалось создать платёж.'); return; }

  const open = Telegram?.WebApp?.openInvoice?.(resp.link, async (status) => {
    if (status === 'paid') {
      await refreshBalance();
      alert('Покупка успешна!');
    } else if (status === 'cancelled') {
      alert('Платёж отменён');
    } else if (status === 'failed') {
      alert('Платёж не прошёл');
    }
  });
  try { await open; await refreshBalance(); } catch {}
  closeAllSheets();
};

// init
auth();
poll();
setInterval(poll, 1000);
</script>
</body>
</html>
