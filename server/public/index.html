<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Real Price BTC Game</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root{
    --bg:#000; --text:#fff; --muted:#b9b9b9; --ring:#ff8c00;
    --green:#1fa36a; --red:#c6423a; --card:#0b0b0b; --border:#1e1e1e; --chip:#121212;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial}
  .wrap{max-width:520px;margin:0 auto;padding:16px 14px 28px}
  .price{font-size:24px;font-weight:800;text-align:center;margin-top:2px}
  .sub{font-size:12px;color:var(--muted);text-align:center;margin:2px 0 8px}
  .balance{text-align:center;font-size:16px;margin:4px 0 8px}

  /* –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤—Å–ø—ã—à–µ–∫ */
  .flash-target { position: relative; }

  /* –∑–µ–ª—ë–Ω–∞—è/–∫—Ä–∞—Å–Ω–∞—è –≤—Å–ø—ã—à–∫–∞ —Ä–∞–º–∫–∏ */
  .flash-green, .flash-red {
    box-shadow: 0 0 0 2px rgba(255,255,255,0);
    animation-duration: 600ms;
    animation-fill-mode: forwards;
  }
  @keyframes flashG {
    0%   { box-shadow: 0 0 0 0 rgba(31,163,106,0.0); }
    30%  { box-shadow: 0 0 0 4px rgba(31,163,106,0.9); }
    100% { box-shadow: 0 0 0 0 rgba(31,163,106,0.0); }
  }
  @keyframes flashR {
    0%   { box-shadow: 0 0 0 0 rgba(198,66,58,0.0); }
    30%  { box-shadow: 0 0 0 4px rgba(198,66,58,0.9); }
    100% { box-shadow: 0 0 0 0 rgba(198,66,58,0.0); }
  }
  .flash-green { animation-name: flashG; }
  .flash-red   { animation-name: flashR;  }

  /* –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ —Å—É–º–º—ã */
  .float-amount {
    position: absolute; left: 50%; top: -8px; transform: translateX(-50%);
    font-weight: 800; pointer-events: none; opacity: 0;
    animation: floatUp 700ms ease-out forwards;
    text-shadow: 0 1px 0 rgba(0,0,0,.6);
  }
  .float-plus  { color:#1fa36a; }
  .float-minus { color:#c6423a; }

  @keyframes floatUp {
    0%   { transform: translate(-50%, 0);    opacity: 0; }
    15%  { transform: translate(-50%, -6px); opacity: .95; }
    100% { transform: translate(-50%, -28px); opacity: 0; }
  }
  .center{display:flex;justify-content:center;align-items:center;margin:8px 0}
  .timer{position:relative;width:300px;height:300px}
  .timer svg{width:100%;height:100%;display:block;transform:rotate(-90deg)}
  .t{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:44px;font-weight:800}
  .phase{text-align:center;color:var(--muted);margin-top:10px}
  .bank{text-align:center;color:#fff;font-size:18px;margin-top:6px}
  .row{display:flex;gap:14px;justify-content:center;margin:12px 0}
  .btn{flex:1;border:none;border-radius:16px;padding:14px 0;color:#fff;font-size:20px;font-weight:800;cursor:pointer}
  .btn:active{transform:translateY(1px) scale(.99)}
  .btn[disabled]{opacity:.5;cursor:not-allowed;pointer-events:none} /* –±–ª–æ–∫ –∫–ª–∏–∫–æ–≤, –∫–æ–≥–¥–∞ disabled */
  .buy{background:var(--green)} .sell{background:var(--red)}

  .menu{display:flex;gap:10px;justify-content:center;margin:8px 0 10px;flex-wrap:wrap}
  .chipbtn{background:#121212;border:1px solid var(--border);border-radius:999px;padding:8px 12px;font-size:13px;color:#fff;cursor:pointer}

  .history{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:4px 0 10px}
  .chip{background:var(--chip);border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;display:flex;gap:6px;align-items:center}
  .up{color:#5ad19c}.down{color:#ff6b6b}

  .head{color:var(--muted);font-size:13px;margin:10px 0 6px;text-align:center}
  .lb{display:grid;grid-template-columns:1fr;gap:8px}
  .rank{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px 12px;display:flex;justify-content:space-between;align-items:center}
  .rank .left{display:flex;gap:8px;align-items:center}
  .badge{width:24px;height:24px;border-radius:999px;background:#222;display:flex;align-items:center;justify-content:center;font-weight:800}

  /* bottom sheets */
  .sheet-backdrop{position:fixed;inset:0;background:#0008;opacity:0;pointer-events:none;transition:.2s}
  .sheet-backdrop.show{opacity:1;pointer-events:auto}
  .sheet{position:fixed;left:0;right:0;bottom:-60%;background:#0b0b0b;border-top:1px solid var(--border);
         border-radius:16px 16px 0 0;padding:14px 14px 18px;transition:.25s}
  .sheet.open{bottom:0}
  .sheet h3{margin:6px 0 10px;font-size:16px}
  .rowchips{display:flex;gap:8px;flex-wrap:wrap}
  .chipopt{background:#121212;border:1px solid var(--border);border-radius:999px;padding:8px 12px;font-size:13px;cursor:pointer}
  .chipopt.active{outline:2px solid var(--ring)}
  .inputline{display:flex;gap:8px;margin:10px 0}
  .inputline input{flex:1;background:#121212;border:1px solid var(--border);border-radius:10px;
                   padding:10px;color:#fff;font-size:14px}
  .switchline{display:flex;justify-content:space-between;align-items:center;margin:8px 0;color:#ddd}
  .sheet .btnrow{display:flex;gap:10px;margin-top:10px}
  .sheet .btnrow .btnsm{flex:1;background:var(--green);border:none;border-radius:12px;color:#fff;padding:10px 0;font-weight:700}
  .sheet .btnrow .btnsm.cancel{background:#333}
  .sheet p{color:#ddd;font-size:13px;line-height:1.35;margin:6px 0}

  .adline{
    background: var(--card);
    border:1px solid var(--border);
    border-radius:16px;
    padding:12px;
    margin:8px 0 12px;
    display:flex;
    gap:12px;
  }
  .ad-left{ flex:1; }
  .ad-top{ display:flex; align-items:center; gap:8px; margin-bottom:4px; }
  .crown{ font-size:20px; line-height:1 }
  .ad-user{ font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .ad-text{
    color:#ddd;
    font-size:14px;
    line-height:1.3;
    overflow:hidden;
    display:-webkit-box;
    -webkit-line-clamp:3;
    -webkit-box-orient:vertical;
  }
  .ad-actions{ display:flex; flex-direction:column; align-items:flex-end; gap:6px; }
  .ad-price{ color:var(--muted); font-size:13px; text-align:right }
  .ad-write{ padding:10px 14px }
  .ad-info{ display:flex; justify-content:space-between; align-items:center; margin:6px 0 0; }
  .ad-count{ color:var(--muted); font-size:13px }
  .ad-enter{ color:var(--muted); font-size:13px }
  .ad-text-change{ animation: adTextChange .3s ease-out }
  @keyframes adTextChange{
    from{ opacity:0; transform:translateY(4px); }
    to{ opacity:1; transform:translateY(0); }
  }

  /* ===== accessibility ===== */
  @media (prefers-reduced-motion: reduce) {
    .flash-win, .shake-outbid, .crown-bounce, .ad-shimmer::before {
      animation: none !important;
      transition: none !important;
    }
  }

  /* ===== –±–∞–∑–æ–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ ===== */
  #adLine {
    position: relative;
    overflow: hidden;
  }

  /* –ª—ë–≥–∫–∏–π –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π —à–∏–º–µ—Ä —Ä–∞–º–∫–∏ */
  .ad-shimmer::before {
    content:"";
    position:absolute; inset:-1px;
    border-radius:inherit;
    pointer-events:none;
    background:
      radial-gradient(60% 60% at 10% 10%, #ffffff18, transparent 60%) ,
      radial-gradient(60% 60% at 90% 90%, #ffffff10, transparent 60%);
    filter: blur(6px);
    opacity:.0;
    animation: shimmer 4s ease-in-out infinite;
  }
  @keyframes shimmer {
    0%,60%,100% { opacity:.0; }
    20% { opacity:.35; }
  }

  /* –≤—Å–ø—ã—à–∫–∞ –ø–æ–±–µ–¥—ã */
  .flash-win {
    animation: flashWin 520ms ease-out;
    box-shadow: 0 0 0 0 rgba(46, 204, 113, .55);
  }
  @keyframes flashWin {
    0%   { box-shadow: 0 0 0 0 rgba(46, 204, 113, .8); border-color:#27ae60; }
    50%  { box-shadow: 0 0 16px 6px rgba(46, 204, 113, .35); }
    100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); }
  }

  /* –≤—Å—Ç—Ä—è—Å–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–±–∏—Ç–∏–∏ */
  .shake-outbid {
    animation: shakeOutbid 420ms cubic-bezier(.36,.07,.19,.97);
  }
  @keyframes shakeOutbid {
    10%, 90% { transform: translateX(-1px); }
    20%, 80% { transform: translateX(2px); }
    30%, 50%, 70% { transform: translateX(-4px); }
    40%, 60% { transform: translateX(4px); }
  }

  /* –ø–æ–¥–ø—Ä—ã–≥–∏–≤–∞–Ω–∏–µ –∫–æ—Ä–æ–Ω—ã –ø—Ä–∏ —Å–º–µ–Ω–µ –ª–∏–¥–µ—Ä–∞ */
  .crown-bounce {
    display:inline-block;
    animation: crownBounce 600ms ease-out;
    transform-origin: 50% 100%;
  }
  @keyframes crownBounce {
    0%   { transform: translateY(0) scale(1) rotate(0); }
    35%  { transform: translateY(-6px) scale(1.05) rotate(-6deg); }
    60%  { transform: translateY(0)  scale(1) rotate(0); }
    80%  { transform: translateY(-2px) scale(1.02);}
    100% { transform: translateY(0)  scale(1); }
  }

  /* –ø–ª–∞–≤–Ω–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ —Ü–µ–Ω—ã –ø—Ä–∏ –µ—ë –∏–∑–º–µ–Ω–µ–Ω–∏–∏ */
  .ad-price-changed {
    animation: pricePulse 600ms ease-out;
  }
  @keyframes pricePulse {
    0%   { color:#fff; text-shadow: 0 0 0 rgba(255,255,255,0); }
    50%  { color:#9be7a1; text-shadow: 0 0 6px rgba(155,231,161,.6); }
    100% { color:#fff; text-shadow: 0 0 0 rgba(255,255,255,0); }
  }
</style>
</head>
<body>
<div id="tgOnly" style="display:none;position:fixed;inset:0;background:#000;color:#fff;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:8px;z-index:9999;text-align:center;padding:24px">
  <div style="font-size:18px;font-weight:700">–û—Ç–∫—Ä–æ–π –∏–≥—Ä—É –≤ Telegram</div>
  <div style="opacity:.8">–ú–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ Telegram</div>
  <a href="https://t.me/realpricebtc_bot" style="margin-top:6px;background:#2ea44f;color:#fff;padding:10px 14px;border-radius:10px;text-decoration:none">–û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞</a>
</div>
<div class="wrap">
  <div class="price" id="price">$‚Äî</div>
  <div class="sub"   id="sub">–°—Ç–∞—Ä—Ç: ‚Äî</div>
  <div class="balance flash-target" id="bal">–ë–∞–ª–∞–Ω—Å: $‚Äî</div>

  <div class="center">
    <div class="timer">
      <svg viewBox="0 0 320 320" preserveAspectRatio="xMidYMid meet">
        <circle cx="160" cy="160" r="140" stroke="#1f1f1f" stroke-width="14" fill="none"/>
        <circle id="ring" cx="160" cy="160" r="140" stroke="var(--ring)" stroke-width="14" fill="none"
                stroke-linecap="round" stroke-dasharray="879.645" stroke-dashoffset="0"/>
      </svg>
      <div class="t" id="tleft">00:60</div>
    </div>
  </div>

  <div class="phase" id="phase">–°—Ç–∞–≤–∫–∏ –æ—Ç–∫—Ä—ã—Ç—ã</div>
  <div class="bank" id="bank">–ë–∞–Ω–∫: $0</div>
  <div class="bank" id="myBet"></div>

  <div class="row">
    <button class="btn buy" id="buy">‚Üë BUY</button>
    <button class="btn sell" id="sell">‚Üì SELL</button>
  </div>

  <!-- –º–µ–Ω—é: –ë–ï–ó –∫–Ω–æ–ø–∫–∏ "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å" -->
  <div class="menu">
    <button class="chipbtn" id="cfgBtn">‚öôÔ∏è –°—Ç–∞–≤–∫–∞</button>
    <button class="chipbtn" id="refBtn">–†–µ—Ñ–µ—Ä–∞–ª—ã</button>
    <button class="chipbtn" id="topupBtn">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</button>
    <button class="chipbtn" id="insBtn">–°—Ç—Ä–∞—Ö–æ–≤–∫–∏</button>
    <button class="chipbtn" id="statsBtn">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
    <button class="chipbtn" id="starsBtn">–ö—É–ø–∏—Ç—å ‚≠ê</button>
  </div>

  <div class="adline ad-shimmer" id="adLine">
    <div class="ad-left">
      <div class="ad-top">
        <span class="crown">üëë</span>
        <span class="ad-user" id="adUser">@user</span>
      </div>
      <div class="ad-text" id="adText">–°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è‚Ä¶</div>
    </div>
    <div class="ad-actions">
      <div class="ad-price" id="adPrice">–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞: $100 (—à–∞–≥ $100)</div>
      <button class="chipbtn ad-write" id="adWrite">‚úçÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å</button>
    </div>
  </div>

  <div class="history" id="hist"></div>

  <div class="head">–¢–æ–ø –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π –∑–∞ —á–∞—Å</div>
  <div class="lb" id="lb"></div>
</div>

<!-- Backdrop -->
<div class="sheet-backdrop" id="sheetBg"></div>

<!-- SHEET: –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç–∞–≤–∫–∏ -->
<div class="sheet" id="sheetStake">
  <h3>–°—É–º–º–∞ —Å—Ç–∞–≤–∫–∏</h3>
  <div class="rowchips" id="chips">
    <button class="chipopt" data-v="50">$50</button>
    <button class="chipopt" data-v="100">$100</button>
    <button class="chipopt" data-v="250">$250</button>
    <button class="chipopt" data-v="500">$500</button>
    <button class="chipopt" data-v="1000">$1000</button>
  </div>
  <div class="inputline">
    <input id="customAmt" type="number" min="50" step="1" placeholder="–î—Ä—É–≥–∞—è —Å—É–º–º–∞, $ (‚â•50)">
  </div>
  <div class="switchline">
    <span>–°—Ç–∞–≤–∏—Ç—å –≤ 1 –∫–ª–∏–∫ (–±–µ–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è)</span>
    <label><input type="checkbox" id="oneClick"></label>
  </div>
  <div class="btnrow">
    <button class="btnsm cancel" data-close>–û—Ç–º–µ–Ω–∞</button>
    <button class="btnsm" id="cfgSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>
</div>

<!-- SHEET: –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ (–ø–æ–¥–ø–∏—Å–∫–∞/–ø—Ä–æ–≤–µ—Ä–∫–∞/–µ–∂–µ–¥–Ω–µ–≤–∫–∞/—Ä–µ—Ñ) -->
<div class="sheet" id="sheetTopup">
  <h3>–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞</h3>
  <p>‚Ä¢ +$5000 ‚Äî –∑–∞ –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ –∫–∞–Ω–∞–ª @erc20coin (–æ–¥–∏–Ω —Ä–∞–∑)</p>
  <p>‚Ä¢ +$1000 ‚Äî –∑–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –≤—Ö–æ–¥</p>
  <p>‚Ä¢ +$500 ‚Äî –∑–∞ –∫–∞–∂–¥–æ–≥–æ –¥—Ä—É–≥–∞ –ø–æ —Ä–µ—Ñ-—Å—Å—ã–ª–∫–µ</p>
  <div class="btnrow">
    <button class="btnsm" id="openChannel">–û—Ç–∫—Ä—ã—Ç—å –∫–∞–Ω–∞–ª</button>
    <button class="btnsm" id="checkBonus">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
  </div>
  <div class="btnrow">
    <button class="btnsm cancel" data-close>–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<!-- SHEET: –ø–æ–∫—É–ø–∫–∞ Stars -->
<div class="sheet" id="sheetStars">
  <h3>–ö—É–ø–∏—Ç—å –∑–≤—ë–∑–¥—ã ‚≠ê</h3>
  <p>–í—ã–±–µ—Ä–∏ –ø–∞–∫–µ—Ç, –æ–ø–ª–∞—Ç–∏ –≤ Telegram Stars ‚Äî –±–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</p>
  <div class="rowchips" id="starsPacks">
    <button class="chipopt" data-pack="100">100‚≠ê ‚Üí $3 000</button>
    <button class="chipopt" data-pack="500">500‚≠ê ‚Üí $16 000</button>
    <button class="chipopt" data-pack="1000">1000‚≠ê ‚Üí $35 000</button>
    <button class="chipopt" data-pack="10000">10000‚≠ê ‚Üí $400 000</button>
    <button class="chipopt" data-pack="30000">30000‚≠ê ‚Üí $1 500 000</button>
  </div>
  <div class="btnrow">
    <button class="btnsm cancel" data-close>–û—Ç–º–µ–Ω–∞</button>
    <button class="btnsm" id="buyStars">–û–ø–ª–∞—Ç–∏—Ç—å</button>
  </div>
</div>

<!-- SHEET: —Å—Ç—Ä–∞—Ö–æ–≤–∫–∏ -->
<div class="sheet" id="sheetIns">
  <h3>–°—Ç—Ä–∞—Ö–æ–≤–∫–∏</h3>
  <p>–í–æ–∑–≤—Ä–∞—â–∞—é—Ç 50% –æ—Ç —Å—É–º–º—ã –ø—Ä–æ–∏–≥—Ä—ã—à–∞</p>
  <p>1000‚≠ê ‚Üí 100 —Å—Ç—Ä–∞—Ö–æ–≤–æ–∫</p>
  <p id="insCount">–î–æ—Å—Ç—É–ø–Ω–æ: 0</p>
  <div class="btnrow">
    <button class="btnsm cancel" data-close>–ó–∞–∫—Ä—ã—Ç—å</button>
    <button class="btnsm" id="buyIns">–ö—É–ø–∏—Ç—å –∑–∞ ‚≠ê</button>
  </div>
</div>

<!-- SHEET: —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="sheet" id="sheetStats">
  <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
  <p>–ü–æ–±–µ–¥: <span id="statsWins">0</span></p>
  <p>–ü–æ—Ä–∞–∂–µ–Ω–∏–π: <span id="statsLosses">0</span></p>
  <div id="statsList"></div>
  <div class="btnrow">
    <button class="btnsm cancel" data-close>–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<!-- SHEET: –∞—É–∫—Ü–∏–æ–Ω —Å–æ–æ–±—â–µ–Ω–∏—è -->
<div class="sheet" id="sheetAd">
  <h3>–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</h3>
  <div class="inputline">
    <input id="adInput" type="text" maxlength="80" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ (–¥–æ 80 —Å–∏–º–≤–æ–ª–æ–≤)">
  </div>
  <div class="ad-info">
    <div class="ad-count" id="adCount">0/80</div>
    <div class="ad-enter" id="adEnter">–í–æ–π—Ç–∏ —Å–µ–π—á–∞—Å: $100</div>
  </div>
  <div class="btnrow">
    <button class="btnsm cancel" data-close>–û—Ç–º–µ–Ω–∞</button>
    <button class="btnsm" id="adSend" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </div>
</div>

<script>
const tg = window.Telegram?.WebApp;
const initData = tg?.initData || '';
const initUser = tg?.initDataUnsafe?.user || null;

// –µ—Å–ª–∏ –Ω–µ –∏–∑ Telegram ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫—É –∏ –≤—ã—Ö–æ–¥–∏–º
if (!initUser || !initData) {
  document.getElementById('tgOnly').style.display = 'flex';
  // –≤–∞–∂–Ω–æ: –¥–∞–ª—å—à–µ –ù–ò–ß–ï–ì–û –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ–º (–Ω–∏–∫–∞–∫–∏—Ö fetch –∫ /api)
  throw new Error('Not in Telegram WebApp');
}

// –Ω–æ—Ä–º–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
const uid = initUser.id;
const username = initUser.username ? '@' + initUser.username : null;

try { tg.expand(); } catch {}

// === –£–ö–ê–ñ–ò –ò–ú–Ø –°–í–û–ï–ì–û –ë–û–¢–ê (–±–µ–∑ @) ===
const BOT_USERNAME = 'realpricebtc_bot';
const CHANNEL_LINK = 'https://t.me/erc20coin';

let CURRENT_PHASE = 'idle'; // <-- –≥–ª–æ–±–∞–ª—å–Ω–æ —Ö—Ä–∞–Ω–∏–º —Ç–µ–∫—É—â—É—é —Ñ–∞–∑—É
let INS_COUNT = 0;
let lastShownSettlementKey = null;

const BID_STEP = 100;

let adState = {
  user: '',
  text: '',
  price: 100,
  step: BID_STEP
};

let prevAd = null;

// elements
const priceEl = document.getElementById('price');
const subEl   = document.getElementById('sub');
const balEl   = document.getElementById('bal');
const ring    = document.getElementById('ring');
const tleft   = document.getElementById('tleft');
const phaseEl = document.getElementById('phase');
const bankEl  = document.getElementById('bank');
const myBetEl = document.getElementById('myBet');
const buyBtn  = document.getElementById('buy');
const sellBtn = document.getElementById('sell');
const histEl  = document.getElementById('hist');
const lbEl    = document.getElementById('lb');
const adLine     = document.getElementById('adLine');
const adUserEl   = document.getElementById('adUser');
const adTextEl   = document.getElementById('adText');
const adPriceEl  = document.getElementById('adPrice');
const adWriteBtn = document.getElementById('adWrite');

const refBtn  = document.getElementById('refBtn');
const topupBtn= document.getElementById('topupBtn');
const starsBtn= document.getElementById('starsBtn');
const insBtn  = document.getElementById('insBtn');
const statsBtn= document.getElementById('statsBtn');
const cfgBtn  = document.getElementById('cfgBtn');

// sheets
const sheetBg     = document.getElementById('sheetBg');
const sheetStake  = document.getElementById('sheetStake');
const sheetTopup  = document.getElementById('sheetTopup');
const sheetStars  = document.getElementById('sheetStars');
const sheetIns    = document.getElementById('sheetIns');
const sheetStats  = document.getElementById('sheetStats');
const sheetAd     = document.getElementById('sheetAd');

// stake controls
const chipsBox  = document.getElementById('chips');
const customAmt = document.getElementById('customAmt');
const oneClick  = document.getElementById('oneClick');
const cfgSave   = document.getElementById('cfgSave');

// topup controls
const openChannel = document.getElementById('openChannel');
const checkBonus  = document.getElementById('checkBonus');

// stars controls
const starsPacks = document.getElementById('starsPacks');
const buyStars   = document.getElementById('buyStars');
const insCountEl = document.getElementById('insCount');
const buyIns     = document.getElementById('buyIns');
const adInput    = document.getElementById('adInput');
const adSend     = document.getElementById('adSend');
const adCount    = document.getElementById('adCount');
const adEnter    = document.getElementById('adEnter');

// –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –Ω–∏–∫: –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –æ–¥–∏–Ω '@'
function normUser(u){
  const name = String(u||'').replace(/^@+/, '');
  return '@' + (name || 'anon');
}

// –ª—ë–≥–∫–∏–π haptic (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω –≤ Telegram WebApp)
function hapticImpact(style = 'light') {
  const H = window.Telegram?.WebApp?.HapticFeedback;
  try {
    if (!H) return;
    if (style === 'success') return H.notificationOccurred('success');
    if (style === 'warning') return H.notificationOccurred('warning');
    if (style === 'error')   return H.notificationOccurred('error');
    H.impactOccurred(style); // 'light' | 'medium' | 'heavy' | 'rigid' | 'soft'
  } catch {}
}

// –Ω–∞–≤–µ—à–∏–≤–∞–µ—Ç/—Å–Ω–∏–º–∞–µ—Ç –∫–ª–∞—Å—Å —Å –∞–≤—Ç–æ—Å–±—Ä–æ—Å–æ–º –ø–æ –æ–∫–æ–Ω—á–∞–Ω–∏–∏ –∞–Ω–∏–º–∞—Ü–∏–∏
function playOnce(el, cls){
  if (!el) return;
  el.classList.remove(cls);
  // —Ñ–æ—Ä—Å-reflow, —á—Ç–æ–±—ã –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∏–º–∞—Ü–∏—é
  // eslint-disable-next-line no-unused-expressions
  el.offsetHeight;
  el.classList.add(cls);
  const off = () => { el.classList.remove(cls); el.removeEventListener('animationend', off); };
  el.addEventListener('animationend', off);
}

function updateAdEnter(){
  const step = Number(adState.step || BID_STEP);
  const enter = Number(adState.price || 0) + step;
  if (adEnter) adEnter.textContent = '–í–æ–π—Ç–∏ —Å–µ–π—á–∞—Å: $' + enter.toLocaleString();
}

// –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å—Ç—Ä–æ–∫–∏
function renderAdLine() {
  const line  = adLine;
  const user  = adUserEl;
  const text  = adTextEl;
  const price = adPriceEl;

  const newUser  = normUser(adState.user);
  const newText  = (adState.text || '').replace(/\n/g, ' ').slice(0, 80);
  const newPrice = Number(adState.price || 0);
  const step     = Number(adState.step || BID_STEP);

  user.textContent  = newUser;
  text.textContent  = newText || '–ü–æ–∫–∞ –ø—É—Å—Ç–æ.';
  if (newText) {
    price.textContent = '–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞: $' + newPrice.toLocaleString() + ' (—à–∞–≥ $' + step.toLocaleString() + ')';
  } else {
    price.textContent = '–í–æ–π—Ç–∏: $' + newPrice.toLocaleString() + ' (—à–∞–≥ $' + step.toLocaleString() + ')';
  }
  updateAdEnter();

  line.classList.add('ad-shimmer');

  if (prevAd) {
    if (prevAd.user !== newUser) {
      playOnce(line, 'shake-outbid');
      const crown = line.querySelector('.crown');
      if (crown) playOnce(crown, 'crown-bounce');
      hapticImpact('medium');
    }

    if (prevAd.price !== newPrice) {
      playOnce(price, 'ad-price-changed');
    }
    if (prevAd.text !== newText) {
      playOnce(text, 'ad-text-change');
    }
  }

  prevAd = { user: newUser, price: newPrice, text: newText };
}
renderAdLine();

// –º–æ–¥–∞–ª–∫–∞ ¬´–Ω–∞–ø–∏—Å–∞—Ç—å¬ª
adWriteBtn.onclick = async ()=>{
  hapticImpact('light');
  adInput.value = '';
  adCount.textContent = '0/80';
  adSend.disabled = true;
  updateAdEnter();
  openSheet(sheetAd);
  adInput.focus();
};

adInput.addEventListener('input', () => {
  const len = adInput.value.length;
  adCount.textContent = len + '/80';
  adSend.disabled = len === 0;
});

adSend.onclick = async ()=>{
  const text = adInput.value.trim().replace(/\n/g,' ').slice(0,80);
  if (!text) return;
  const r = await fetch('/api/shout/post', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ initData, msg:text })
  }).then(r=>r.json()).catch(()=>({ ok:false }));

  if (!r.ok) {
    alert(r.error==='INSUFFICIENT_BALANCE' ? '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤' : '–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ');
    return;
  }

  closeAllSheets();
  playOnce(adLine, 'flash-win');
  hapticImpact('medium');

  await adPoll();
  await refreshBalance();
};

const CIRC = 2*Math.PI*140;
ring.setAttribute('stroke-dasharray', CIRC);

// --- Haptic helpers (Telegram + fallback vibration)
function hapticLight() {
  try { Telegram?.WebApp?.HapticFeedback?.impactOccurred?.('light'); } catch {}
  if (navigator.vibrate) navigator.vibrate(10);
}
function hapticWin() {
  try { Telegram?.WebApp?.HapticFeedback?.notificationOccurred?.('success'); } catch {}
  if (navigator.vibrate) navigator.vibrate([20, 30, 20]);
}
function hapticLose() {
  try { Telegram?.WebApp?.HapticFeedback?.notificationOccurred?.('error'); } catch {}
  if (navigator.vibrate) navigator.vibrate([40, 40, 40]);
}

// --- DOM flash & float amount
function flash(elem, type /* 'green' | 'red' */) {
  if (!elem) return;
  elem.classList.remove('flash-green','flash-red');
  // force reflow
  void elem.offsetWidth;
  elem.classList.add(type === 'green' ? 'flash-green' : 'flash-red');
  setTimeout(()=>elem.classList.remove('flash-green','flash-red'), 650);
}

function floatAmount(parent, text, plus /*true for +, false for -*/) {
  if (!parent) return;
  const span = document.createElement('span');
  span.className = 'float-amount ' + (plus ? 'float-plus' : 'float-minus');
  span.textContent = (plus ? '+' : '-') + '$' + Number(text||0).toLocaleString();
  parent.appendChild(span);
  setTimeout(()=>span.remove(), 750);
}

// helpers
function fmt(n){ return '$'+Number(n||0).toLocaleString(); }
function phaseText(p){
  if (p==='betting') return '–°—Ç–∞–≤–∫–∏ –æ—Ç–∫—Ä—ã—Ç—ã';
  if (p==='locked')  return '–°—Ç–∞–≤–∫–∏ –∑–∞–∫—Ä—ã—Ç—ã';
  if (p==='pause')   return '–ü–∞—É–∑–∞';
  return '–û–∂–∏–¥–∞–Ω–∏–µ';
}
function chip(h){
  const dir = h.side==='BUY'?'‚Üë BUY':'‚Üì SELL';
  const cls = h.side==='BUY'?'up':'down';
  const pct = (h.pct>0?'+':'') + h.pct.toFixed(2) + '%';
  return `<div class="chip"><span class="${cls}">${dir}</span><span class="${cls}">${pct}</span><span>${fmt(h.win)}</span></div>`;
}

// sheet helpers
function openSheet(el){ el.classList.add('open'); sheetBg.classList.add('show'); }
function closeAllSheets(){
  [sheetStake, sheetTopup, sheetStars, sheetIns, sheetStats, sheetAd].forEach(s=>s.classList.remove('open'));
  sheetBg.classList.remove('show');
}
sheetBg.addEventListener('click', closeAllSheets);
document.querySelectorAll('[data-close]').forEach(btn=>btn.addEventListener('click', closeAllSheets));

// settings storage
function getSettings(){
  return {
    amount: Math.max(50, Number(localStorage.getItem('bet_amount')||100) || 100),
    oneClick: localStorage.getItem('bet_oneclick') === '1'
  };
}
function setSettings(s){
  localStorage.setItem('bet_amount', String(Math.max(50, s.amount||100)));
  localStorage.setItem('bet_oneclick', s.oneClick ? '1' : '0');
}
function highlightChips(val){
  document.querySelectorAll('#chips .chipopt').forEach(b=>{
    b.classList.toggle('active', Number(b.dataset.v)===Number(val));
  });
}

// api
async function auth(){
  const r = await fetch('/api/auth',{
    method:'POST', headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ initData })
  }).then(r=>r.json()).catch(()=>({ok:false}));
  if (r.ok) {
    balEl.textContent = '–ë–∞–ª–∞–Ω—Å: ' + fmt(r.user.balance);
    INS_COUNT = Number(r.user.insurance || 0);
    if (insCountEl) insCountEl.textContent = '–î–æ—Å—Ç—É–ø–Ω–æ: ' + INS_COUNT;
  }
}
async function refreshBalance(){
  const r = await fetch('/api/auth',{
    method:'POST', headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ initData })
  }).then(r=>r.json()).catch(()=>({ok:false}));
  if (r.ok) {
    balEl.textContent = '–ë–∞–ª–∞–Ω—Å: ' + fmt(r.user.balance);
    INS_COUNT = Number(r.user.insurance || 0);
    if (insCountEl) insCountEl.textContent = '–î–æ—Å—Ç—É–ø–Ω–æ: ' + INS_COUNT;
  }
}
async function leaderboard(){
  const r = await fetch(`/api/leaderboard?initData=${encodeURIComponent(initData)}`).then(r=>r.json()).catch(()=>({ok:false}));
  if (!r.ok) return;
  lbEl.innerHTML = (r.top||[]).map((x,i)=>`
    <div class="rank">
      <div class="left">
        <div class="badge">${i+1}</div>
        <div class="name">${x.name}</div>
      </div>
      <div class="val">${fmt(x.won)}</div>
    </div>
  `).join('') || '<div class="rank"><div class="left"><div class="badge">‚Äî</div><div class="name">–µ—â—ë –ø—É—Å—Ç–æ</div></div><div class="val">$0</div></div>';
}
async function loadStats(){
  const r = await fetch(`/api/stats?initData=${encodeURIComponent(initData)}`).then(r=>r.json()).catch(()=>({ok:false}));
  if (!r.ok) return;
  document.getElementById('statsWins').textContent = Number(r.wins||0);
  document.getElementById('statsLosses').textContent = Number(r.losses||0);
  const listEl = document.getElementById('statsList');
  listEl.innerHTML = (r.list||[]).map(item=>`<div>${item}</div>`).join('');
}

async function adPoll(){
  const r = await fetch(`/api/shout/state?initData=${encodeURIComponent(initData)}`).then(r=>r.json()).catch(()=>null);
  if (!r || !r.ok) return;
  const st = r.state || {};
  adState = {
    user: st.name || '',
    text: st.msg || '',
    price: Number(st.price || 0),
    step: Number(st.step || BID_STEP),
    expiresIn: Number(st.expiresIn || 0)
  };
  renderAdLine();
}

// polling
async function poll(){
  const r = await fetch(`/api/round?initData=${encodeURIComponent(initData)}`).then(r=>r.json()).catch(()=>null);
  if (!r) return;

  if (r.price){
    priceEl.textContent = fmt(r.price);
    if (r.startPrice){
      priceEl.style.color = r.price>r.startPrice?'#1fa36a':(r.price<r.startPrice?'#c6423a':'#fff');
      subEl.textContent = '–°—Ç–∞—Ä—Ç: ' + Math.round(r.startPrice);
    }
  }

  tleft.textContent = '00:' + String(Math.max(r.secsLeft||0,0)).padStart(2,'0');
  const len = r.roundLen||60;
  const progress = Math.max(0, Math.min(1, (len - (r.secsLeft||0))/len));
  ring.style.transition='stroke-dashoffset .5s linear';
  ring.setAttribute('stroke-dashoffset', CIRC*progress);

  CURRENT_PHASE = r.phase || 'idle';         // —Ñ–∏–∫—Å–∏—Ä—É–µ–º —Ç–µ–∫—É—â—É—é —Ñ–∞–∑—É
  phaseEl.textContent = phaseText(CURRENT_PHASE);
  bankEl.textContent  = '–ë–∞–Ω–∫: ' + fmt(r.bank);

  const myId   = String(uid);
  const myBuy  = (r.betsBuy  || []).filter(b => String(b.user) === myId).reduce((s,b)=>s+(b.amount||0),0);
  const mySell = (r.betsSell || []).filter(b => String(b.user) === myId).reduce((s,b)=>s+(b.amount||0),0);
  myBetEl.textContent = '–¢–≤–æ—è —Å—Ç–∞–≤–∫–∞: ' + fmt(myBuy + mySell);

  const open = CURRENT_PHASE === 'betting';  // —Ç–æ–ª—å–∫–æ –≤ betting ‚Äî –∞–∫—Ç–∏–≤–Ω—ã –∫–Ω–æ–ø–∫–∏
  buyBtn.disabled  = !open;
  sellBtn.disabled = !open;

  const h = await fetch(`/api/history?initData=${encodeURIComponent(initData)}`).then(r=>r.json()).catch(()=>({history:[]}));
  histEl.innerHTML = (h.history||[]).map(chip).join('');

  await refreshBalance();
  await leaderboard();
  await adPoll();

  // --- Result animation during pause
  if (r.phase === 'pause' && r.lastSettlement) {
    const key = JSON.stringify(r.lastSettlement);
    if (key !== lastShownSettlementKey) {
      lastShownSettlementKey = key;

      // –∫—Ç–æ –≤—ã–∏–≥—Ä–∞–ª
      const winSide = r.lastSettlement.side; // 'BUY' | 'SELL'
      const myId = String(uid);

      // –º–æ—è –≤—ã–ø–ª–∞—Ç–∞
      const myPay = (r.lastSettlement.payouts || []).find(p => String(p.user) === myId)?.amount || 0;

      // —Å–∫–æ–ª—å–∫–æ —è –ø–æ—Å—Ç–∞–≤–∏–ª –Ω–∞ –∫–∞–∂–¥—É—é —Å—Ç–æ—Ä–æ–Ω—É (–≤ —ç—Ç–æ–º —Ä–∞—É–Ω–¥–µ)
      const myBuy  = (r.betsBuy  || []).filter(b => String(b.user) === myId).reduce((s,b)=>s+(b.amount||0),0);
      const mySell = (r.betsSell || []).filter(b => String(b.user) === myId).reduce((s,b)=>s+(b.amount||0),0);

      // –º–æ—è —Å—É–º–º–∞ –ø—Ä–æ–∏–≥—Ä—ã—à–∞ = –º–æ–∏ —Å—Ç–∞–≤–∫–∏ –Ω–∞ –ø—Ä–æ–∏–≥—Ä–∞–≤—à–µ–π —Å—Ç–æ—Ä–æ–Ω–µ
      let myLose = 0;
      if (winSide === 'BUY')  myLose = mySell;
      if (winSide === 'SELL') myLose = myBuy;

      // –≤–æ–∑–º–æ–∂–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç –ø–æ —Å—Ç—Ä–∞—Ö–æ–≤–∫–µ (–µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –µ–≥–æ –ø—Ä–∏—Å—ã–ª–∞–µ—Ç)
      let myRefund = 0;
      const insList = r.lastSettlement.insuranceRefunds || [];
      const meIns = insList.find(x => String(x.user) === myId);
      if (meIns) myRefund = Number(meIns.refund || 0);

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –Ω–∞ –±–ª–æ–∫–µ –±–∞–ª–∞–Ω—Å–∞
      const target = document.getElementById('bal');

      if (myPay > 0) {
        flash(target, 'green');
        floatAmount(target, myPay, true);
        hapticWin();
      } else if (myLose > 0) {
        flash(target, 'red');
        floatAmount(target, myLose, false);
        hapticLose();

        if (myRefund > 0) {
          // –Ω–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã –º–∏–Ω—É—Å –∏ –ø–ª—é—Å –Ω–µ —Å–ª–∏–ª–∏—Å—å
          setTimeout(()=>floatAmount(target, myRefund + ' (—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞)', true), 350);
        }
      }
    }
  }
}

// –¥–µ–π—Å—Ç–≤–∏—è —Å—Ç–∞–≤–æ–∫
async function place(side){
  // –∑–∞—â–∏—Ç–∞ –æ—Ç –∫–ª–∏–∫–æ–≤ –≤–Ω–µ –æ–∫–Ω–∞ —Å—Ç–∞–≤–æ–∫
  if (CURRENT_PHASE !== 'betting') {
    alert('–û–∫–Ω–æ —Å—Ç–∞–≤–æ–∫ –∑–∞–∫—Ä—ã—Ç–æ');
    return;
  }

  const s = getSettings();
  let amount = s.amount;

  if (!s.oneClick){
    const val = prompt('–°—É–º–º–∞ —Å—Ç–∞–≤–∫–∏ ($):', String(amount));
    if (val === null) return;
    amount = parseInt(val,10);
    if (!amount || amount<=0) return alert('–í–≤–µ–¥–∏ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—É—é —Å—É–º–º—É');
  }
  if (amount < 50){ alert('–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞ $50'); return; }

  const r = await fetch('/api/bet',{
    method:'POST', headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ initData, side, amount })
  }).then(r=>r.json()).catch(()=>({ok:false,error:'SERVER'}));

  if (!r.ok) {
    const msg =
      r.error==='BETTING_CLOSED' ? '–û–∫–Ω–æ —Å—Ç–∞–≤–æ–∫ –∑–∞–∫—Ä—ã—Ç–æ' :
      r.error==='INSUFFICIENT_BALANCE' ? '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤' :
      r.error?.startsWith?.('MIN_BET_') ? `–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞: $${r.error.split('_').pop()}` :
      '–û—à–∏–±–∫–∞: '+(r.error||'UNKNOWN');
    alert(msg);
    return;
  }
  if (r.placed) setSettings({ amount: r.placed, oneClick: s.oneClick });
  await poll();
}
buyBtn.onclick  = () => { hapticLight(); place('BUY'); };
sellBtn.onclick = () => { hapticLight(); place('SELL'); };

// –æ—Ç–∫—Ä—ã—Ç—å –ª–∏—Å—Ç—ã
cfgBtn.onclick   = ()=>{ highlightChips(getSettings().amount); customAmt.value=''; oneClick.checked=getSettings().oneClick; openSheet(sheetStake); };
topupBtn.onclick = ()=> openSheet(sheetTopup);
insBtn.onclick  = ()=>{ insCountEl.textContent = '–î–æ—Å—Ç—É–ø–Ω–æ: ' + INS_COUNT; openSheet(sheetIns); };
starsBtn.onclick = ()=> openSheet(sheetStars);
statsBtn.onclick = () => { loadStats(); openSheet(sheetStats); };

// stake sheet handlers
chipsBox.addEventListener('click', (e)=>{
  const b = e.target.closest('.chipopt'); if (!b) return;
  document.querySelectorAll('#chips .chipopt').forEach(x=>x.classList.remove('active'));
  b.classList.add('active'); customAmt.value='';
});
cfgSave.onclick = ()=>{
  let val = Number(customAmt.value || 0);
  if (!val){
    const active = document.querySelector('#chips .chipopt.active');
    val = active ? Number(active.dataset.v) : getSettings().amount;
  }
  if (val < 50) { alert('–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞ $50'); return; }
  setSettings({ amount: Math.floor(val), oneClick: oneClick.checked });
  closeAllSheets();
  alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: $' + Math.floor(val) + (oneClick.checked ? ' ‚Ä¢ 1-–∫–ª–∏–∫' : ''));
};

// topup sheet handlers
openChannel.onclick = ()=>{
  try{
    if (window.Telegram?.WebApp?.openTelegramLink) Telegram.WebApp.openTelegramLink(CHANNEL_LINK);
    else window.location.href = CHANNEL_LINK;
  }catch(e){ window.location.href = CHANNEL_LINK; }
};
// –Ω–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ ‚Äî –¥–µ—Ä–≥–∞–µ–º –≤–∞—à API
checkBonus.onclick = async ()=>{
  const r = await fetch('/api/bonus/check', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ initData })
  }).then(r=>r.json()).catch(()=>({ ok:false }));

  if (!r.ok) { alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –±–æ–Ω—É—Å.'); return; }

  if (r.added > 0) {
    await refreshBalance();
    alert('–ù–∞—á–∏—Å–ª–µ–Ω–æ: $' + Number(r.added).toLocaleString());
  } else {
    alert(r.msg || '–ü–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞—á–∏—Å–ª–µ–Ω–æ.');
  }
  closeAllSheets();
};


// —Ä–µ—Ñ–µ—Ä–∞–ª—ã
refBtn.onclick = ()=>{
  const link = `https://t.me/${BOT_USERNAME}?start=${uid}`;
  if (navigator.share){
    navigator.share({ title:'BTC Game', text:'–ó–∞–ª–µ—Ç–∞–π –≤ –∏–≥—Ä—É!', url:link }).catch(()=>{});
  } else {
    alert('–¢–≤–æ—è —Ä–µ—Ñ-—Å—Å—ã–ª–∫–∞:\n' + link + '\n–ó–∞ –∫–∞–∂–¥–æ–≥–æ –¥—Ä—É–≥–∞ +$500 –ø–æ—Å–ª–µ –µ–≥–æ –ø–µ—Ä–≤–æ–≥–æ –≤—Ö–æ–¥–∞.');
  }
};

// Stars: –≤—ã–±–æ—Ä –ø–∞–∫–µ—Ç–∞ –∏ –æ–ø–ª–∞—Ç–∞
let selectedPack = null;
starsPacks.addEventListener('click', (e)=>{
  const b = e.target.closest('.chipopt'); if (!b) return;
  document.querySelectorAll('#starsPacks .chipopt').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  selectedPack = b.dataset.pack;
});
buyStars.onclick = async ()=>{
  const pack = selectedPack || '100';
  const resp = await fetch('/api/stars/create', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ initData, pack })
  }).then(r=>r.json()).catch(()=>({ ok:false }));
  if (!resp.ok) { alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç—ë–∂.'); return; }

  const open = Telegram?.WebApp?.openInvoice?.(resp.link, async (status) => {
    if (status === 'paid') {
      await refreshBalance();
      alert('–û–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–∞! –ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª—ë–Ω.');
    } else if (status === 'cancelled') {
      alert('–ü–ª–∞—Ç—ë–∂ –æ—Ç–º–µ–Ω—ë–Ω');
    } else if (status === 'failed') {
      alert('–ü–ª–∞—Ç—ë–∂ –Ω–µ –ø—Ä–æ—à—ë–ª');
    }
  });
  try { await open; await refreshBalance(); } catch {}
  closeAllSheets();
};

buyIns.onclick = async ()=>{
  const resp = await fetch('/api/insurance/create', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ initData })
  }).then(r=>r.json()).catch(()=>({ ok:false }));
  if (!resp.ok) { alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç—ë–∂.'); return; }

  const open = Telegram?.WebApp?.openInvoice?.(resp.link, async (status) => {
    if (status === 'paid') {
      await refreshBalance();
      alert('–ü–æ–∫—É–ø–∫–∞ —É—Å–ø–µ—à–Ω–∞!');
    } else if (status === 'cancelled') {
      alert('–ü–ª–∞—Ç—ë–∂ –æ—Ç–º–µ–Ω—ë–Ω');
    } else if (status === 'failed') {
      alert('–ü–ª–∞—Ç—ë–∂ –Ω–µ –ø—Ä–æ—à—ë–ª');
    }
  });
  try { await open; await refreshBalance(); } catch {}
  closeAllSheets();
};

// init
auth();
poll();
setInterval(poll, 1000);
</script>
</body>
</html>
