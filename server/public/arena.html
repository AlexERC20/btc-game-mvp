<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–ê—Ä–µ–Ω–∞</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  body{background:#000;color:#fff;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;margin:0;padding:16px;}
  .arena-title{text-align:center;font-size:28px;font-weight:800;margin:0 0 20px;}
  .ring{position:relative;margin:20px auto;width:260px;height:260px;border:4px solid var(--ring,#ff8c00);border-radius:50%;display:flex;flex-direction:column;justify-content:center;align-items:center;pointer-events:none;}
  .bank{font-size:24px;font-weight:800;}
  .phase{font-size:14px;color:#ccc;margin-top:8px;}
  .bid-btn{width:100%;margin-top:24px;padding:14px 0;border:none;border-radius:16px;background:#1fa36a;color:#fff;font-size:20px;font-weight:800;cursor:pointer;position:relative;z-index:5;pointer-events:auto;}
  .bid-btn.disabled{opacity:.5;cursor:not-allowed;}
  .leader{text-align:center;margin-top:16px;font-size:16px;}
  .chat-menu{display:flex;gap:12px;justify-content:center;margin-top:24px;}
  .chat-menu button{background:#121212;border:1px solid #333;border-radius:12px;color:#fff;padding:10px 16px;font-size:14px;cursor:pointer;}
  .sheet-backdrop{position:fixed;inset:0;background:#0008;opacity:0;pointer-events:none;transition:opacity .2s;}
  .sheet-backdrop.show{opacity:1;pointer-events:auto;}
  .sheet{position:fixed;left:0;right:0;bottom:0;background:#0b0b0b;border-top:1px solid #1e1e1e;border-radius:16px 16px 0 0;transform:translateY(100%);transition:transform .25s ease;padding:16px;max-height:90vh;display:flex;flex-direction:column;z-index:1000;}
  .sheet.open{transform:translateY(0);}
  #chatFeed{flex:1;overflow:auto;margin-bottom:12px;}
  .msg{margin-bottom:8px;font-size:14px;}
  .msg .meta{color:#aaa;font-size:12px;}
  .msg .text{white-space:pre-wrap;}
  .sheet input{width:100%;padding:8px;border-radius:8px;border:1px solid #333;background:#121212;color:#fff;}
  .sheet button{margin-top:8px;padding:10px;border:none;border-radius:8px;background:#1fa36a;color:#fff;font-weight:700;cursor:pointer;}
  .ring, .decor, .overlays, .shadow { pointer-events: none; }
</style>
</head>
<body>
<h1 class="arena-title">–ê—Ä–µ–Ω–∞</h1>
<div id="arenaRing" class="ring">
  <div id="arenaBank" class="bank">$10 000</div>
  <div id="arenaPhaseLine" class="phase">00:00 ‚Ä¢ –û–∂–∏–¥–∞–µ–º —Å—Ç–∞–≤–∫—É</div>
</div>
<button id="arenaBidBtn" class="bid-btn">
  –°—Ç–∞–≤–∫–∞ $<span id="arenaBidPrice">50</span>
</button>
<div class="leader">–õ–∏–¥–µ—Ä: <span id="arenaLeader">‚Äî</span></div>
<div class="chat-menu">
  <button id="openChatBtn">–ß–ê–¢</button>
  <button id="writeBtn">üñäÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å</button>
</div>
<div class="sheet-backdrop" id="sheetBg"></div>
<div class="sheet" id="chatSheet">
  <div id="chatFeed"></div>
  <input id="chatInput" placeholder="–í–∞—à —Ç–µ–∫—Å—Ç" maxlength="50" />
  <button id="chatSend">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
</div>
<script>
const tg = window.Telegram?.WebApp;
let placing = false;
let arenaState = null;
let countdownTimer = null;

function formatMoney(n){ return '$' + Number(n).toLocaleString(); }
function setBidEnabled(enabled){
  const btn = document.getElementById('arenaBidBtn');
  btn.disabled = !enabled;
  btn.classList.toggle('disabled', !enabled);
}
function startCountdownTo(ts, cb){
  stopCountdown();
  function tick(){
    const remain = Math.max(0, ts - Date.now());
    const mm = Math.floor(remain/60000).toString().padStart(2,'0');
    const ss = Math.floor((remain%60000)/1000).toString().padStart(2,'0');
    cb(`${mm}:${ss}`);
    if(remain<=0) stopCountdown();
  }
  tick();
  countdownTimer = setInterval(tick, 250);
}
function stopCountdown(){ clearInterval(countdownTimer); countdownTimer=null; }
function showBigBanner(text,color){
  const div=document.createElement('div');
  div.textContent=text;
  div.style.position='fixed';
  div.style.left='50%';div.style.top='40%';div.style.transform='translate(-50%,-50%)';
  div.style.background=color==='green'?'#1fa36a':'#c6423a';
  div.style.color='#fff';div.style.padding='20px 30px';div.style.fontSize='32px';div.style.fontWeight='800';div.style.borderRadius='16px';div.style.zIndex='999';
  document.body.appendChild(div);
  setTimeout(()=>div.remove(),1500);
}
function hapticsImpact(){ navigator.vibrate?.(30); }
function hapticsSuccess(){ navigator.vibrate?.([60,80,60]); }
function hapticsError(){ navigator.vibrate?.([80,100,80]); }
function animateBankBump(){}
function showToast(msg){ alert(msg); }

function applyArenaState(s){
  arenaState = s;
  document.getElementById('arenaBank').textContent = formatMoney(s.bank);
  document.getElementById('arenaLeader').textContent = s.leader || '‚Äî';
  document.getElementById('arenaBidPrice').textContent = s.nextBid;
  const phaseLine = document.getElementById('arenaPhaseLine');
  if(s.phase==='idle'){
    phaseLine.textContent='00:00 ‚Ä¢ –û–∂–∏–¥–∞–µ–º —Å—Ç–∞–≤–∫—É';
    stopCountdown();
  }else{
    startCountdownTo(s.endsAt, mmss=>{ phaseLine.textContent = mmss + ' ‚Ä¢ –ò–¥—ë—Ç –∞—É–∫—Ü–∏–æ–Ω'; });
  }
  if(s.phase==='settling' || s.phase==='closed'){
    stopCountdown();
    if(s.youWin===true){ showBigBanner('YOU WON!','green'); hapticsSuccess(); }
    else if(s.youWin===false){ showBigBanner('YOU LOSE!','red'); hapticsError(); }
  }
  setBidEnabled(['idle','open','overtime'].includes(s.phase));
}

document.getElementById('arenaBidBtn').onclick = async ()=>{
  if(placing || !arenaState) return;
  if(!['idle','open','overtime'].includes(arenaState.phase)) return;
  placing = true; setBidEnabled(false);
  try{
    const res = await fetch('/api/arena/bid', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ roundId: arenaState.roundId, amount: arenaState.nextBid })
    });
    const data = await res.json().catch(()=>null);
    if(!res.ok){ showToast(data?.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É'); }
    else{ applyArenaState(data); hapticsImpact(); animateBankBump(); }
  } finally {
    placing=false;
    setBidEnabled(['idle','open','overtime'].includes(arenaState?.phase));
  }
};

async function pollArena(){
  const r = await fetch('/api/arena/state?initData='+encodeURIComponent(tg?.initData||''))
              .then(r=>r.json()).catch(()=>null);
  if(r) applyArenaState(r);
}
setInterval(pollArena,1000);
pollArena();

// chat sheet
const sheetBg=document.getElementById('sheetBg');
const chatSheet=document.getElementById('chatSheet');
function openSheet(){ sheetBg.classList.add('show'); chatSheet.classList.add('open'); }
function closeSheet(){ sheetBg.classList.remove('show'); chatSheet.classList.remove('open'); }
sheetBg.onclick=closeSheet;
async function refreshShoutState(){
  const r=await fetch('/api/shout/history?limit=50').then(r=>r.json()).catch(()=>({ok:false,items:[]}));
  const feed=document.getElementById('chatFeed');
  if(!r.ok){ feed.innerHTML='<div class="msg"><div class="text">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å.</div></div>'; return; }
  feed.innerHTML=r.items.map(it=>`<div class="msg"><div class="meta">${it.user}</div><div class="text">${it.text}</div></div>`).join('');
  feed.scrollTop=feed.scrollHeight;
}
async function sendShout(){
  const inp=document.getElementById('chatInput');
  const text=inp.value.trim();
  if(!text) return;
  await fetch('/api/shout/bid',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ text, initData: tg?.initData || ''})}).catch(()=>{});
  inp.value='';
  await refreshShoutState();
}
function openShoutSheet(){ refreshShoutState(); openSheet(); }

document.getElementById('openChatBtn').onclick=openShoutSheet;
document.getElementById('writeBtn').onclick=openShoutSheet;
document.getElementById('chatSend').onclick=sendShout;
</script>
</body>
</html>
