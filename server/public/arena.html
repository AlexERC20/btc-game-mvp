<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–ê—Ä–µ–Ω–∞</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root{
    --bg:#000; --text:#fff; --muted:#b9b9b9; --ring:#ff8c00;
    --green:#1fa36a; --red:#c6423a; --card:#0b0b0b; --border:#1e1e1e; --chip:#121212;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial}
  .wrap{max-width:520px;margin:24px auto 0;padding:16px 14px 28px}
  .back-text{background:none;border:none;color:#fff;font-size:14px;padding:0;margin-bottom:6px;cursor:pointer}
  .page-title{font-size:28px;font-weight:800;text-align:center;margin:0 0 12px}
  .price{font-size:24px;font-weight:800;text-align:center;margin-top:2px}
  .sub{font-size:12px;color:var(--muted);text-align:center;margin:2px 0 8px}
  .balance{text-align:center;font-size:16px;margin:4px 0 8px}

  /* –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤—Å–ø—ã—à–µ–∫ */
  .flash-target { position: relative; }

  /* –∑–µ–ª—ë–Ω–∞—è/–∫—Ä–∞—Å–Ω–∞—è –≤—Å–ø—ã—à–∫–∞ —Ä–∞–º–∫–∏ */
  .flash-green, .flash-red {
    box-shadow: 0 0 0 2px rgba(255,255,255,0);
    animation-duration: 600ms;
    animation-fill-mode: forwards;
  }
  @keyframes flashG {
    0%   { box-shadow: 0 0 0 0 rgba(31,163,106,0.0); }
    30%  { box-shadow: 0 0 0 4px rgba(31,163,106,0.9); }
    100% { box-shadow: 0 0 0 0 rgba(31,163,106,0.0); }
  }
  @keyframes flashR {
    0%   { box-shadow: 0 0 0 0 rgba(198,66,58,0.0); }
    30%  { box-shadow: 0 0 0 4px rgba(198,66,58,0.9); }
    100% { box-shadow: 0 0 0 0 rgba(198,66,58,0.0); }
  }
  .flash-green { animation-name: flashG; }
  .flash-red   { animation-name: flashR;  }

  /* –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ —Å—É–º–º—ã */
  .float-amount {
    position: absolute; left: 50%; top: -8px; transform: translateX(-50%);
    font-weight: 800; pointer-events: none; opacity: 0;
    animation: floatUp 700ms ease-out forwards;
    text-shadow: 0 1px 0 rgba(0,0,0,.6);
  }
  .float-plus  { color:#1fa36a; }
  .float-minus { color:#c6423a; }

  @keyframes floatUp {
    0%   { transform: translate(-50%, 0);    opacity: 0; }
    15%  { transform: translate(-50%, -6px); opacity: .95; }
    100% { transform: translate(-50%, -28px); opacity: 0; }
  }
  .center{display:flex;justify-content:center;align-items:center;margin:8px 0}
  .timer{position:relative;width:300px;height:300px}
  .timer svg{width:100%;height:100%;display:block;transform:rotate(-90deg)}
  /* —Å—Ç–µ–∫ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –≤–Ω—É—Ç—Ä–∏ –∫—Ä—É–≥–∞ */
  .inring-stack{
    position:absolute; inset:0;
    display:flex; flex-direction:column;
    align-items:center; justify-content:center;
    pointer-events:none;
  }
  .inring-price{
    font-size: var(--price-font, 38px);
    font-weight:800;
    letter-spacing:0.5px;
    line-height:1;
    color: currentColor;
  }
  @media (max-width:380px){ .inring-price{font-size:34px} }

  .inring-bottom{
    width:70%;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:8px;font-size:clamp(12px,2.8vw,16px);font-weight:800;color:#ddd;
  }

  .bank{text-align:center;color:#fff;font-size:18px;margin-top:6px}
  .btn{width:100%;border:none;border-radius:16px;padding:14px 0;color:#fff;font-size:20px;font-weight:800;cursor:pointer;background:var(--green);margin-top:16px}
  .btn:active{transform:translateY(1px) scale(.99)}
  .btn[disabled]{opacity:.5;cursor:not-allowed}

  .head{color:var(--text);font-size:14px;margin:16px 0;text-align:center}

  /* –∫–∞—Ä—Ç–æ—á–∫–∞ —É—Ä–æ–≤–Ω—è ‚Äî –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∏ –±–∞–ª–∞–Ω—Å–∞ */
  .levelcard { background: var(--card); border:1px solid var(--border); border-radius:16px; padding:14px; margin:12px 0; }
  .level-head { display:flex; align-items:center; justify-content:space-between; gap:12px; }
  .level-title { font-weight:800; font-size:18px; }
  .level-balance { color:#ddd; font-size:14px; white-space:nowrap; }
  .level-bar { height:10px; background:#151515; border-radius:999px; overflow:hidden; margin:10px 0 6px; }
  .level-fill { height:100%; width:0%; background:var(--green); }
  .level-xp { color:#aaa; font-size:12px; }

  .menu{display:flex;gap:10px;justify-content:center;margin:8px 0 10px;flex-wrap:wrap}
  .chipbtn{background:#121212;border:1px solid var(--border);border-radius:999px;padding:8px 12px;font-size:13px;color:#fff;cursor:pointer}

  .adline{
    background: var(--card);
    border:1px solid var(--border);
    border-radius:16px;
    padding:12px;
    margin:8px 0 12px;
    display:flex;
    gap:12px;
  }
  .ad-left{ flex:1; }
  .ad-top{ display:flex; align-items:center; gap:8px; margin-bottom:4px; }
  .crown{ font-size:20px; line-height:1 }
  .ad-user{ font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .ad-text{
    color:#ddd;
    font-size:14px;
    line-height:1.3;
    overflow:hidden;
    display:-webkit-box;
    -webkit-line-clamp:2;
    -webkit-box-orient:vertical;
  }
  .ad-actions{ display:flex; flex-direction:column; align-items:flex-end; gap:6px; }
  .ad-price{ color:var(--muted); font-size:13px; text-align:right }
  .ad-write{ padding:10px 14px }
  .ad-info{ display:flex; justify-content:space-between; align-items:center; margin:6px 0 0; }
  .ad-count{ color:var(--muted); font-size:13px }
  .ad-enter{ color:var(--muted); font-size:13px }

  .lb-head{color:var(--muted);font-size:13px;margin:10px 0 6px;text-align:center}
  .podium{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin:10px 0}
  .pod{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:8px;text-align:center}
  .pod1{order:2;transform:scale(1.05)}
  .pod2{order:1}
  .pod3{order:3}
  .pod .name{font-weight:700}
  .pod .wins{color:#ccc;font-size:12px}
  .pod .sum{font-weight:700;margin-top:2px}
  .lb{display:grid;grid-template-columns:1fr;gap:8px}
  .rank{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px 12px;display:flex;justify-content:space-between;align-items:center}
  .rank .left{display:flex;gap:8px;align-items:center}
  .badge{width:24px;height:24px;border-radius:999px;background:#222;display:flex;align-items:center;justify-content:center;font-weight:800}
  .rank .wins{color:#aaa;font-size:12px;margin-left:4px}

  /* bottom sheets */
  .sheet{position:fixed;left:0;right:0;bottom:0;background:#0b0b0b;border-top:1px solid var(--border);border-radius:16px 16px 0 0;transform:translateY(100%);transition:transform .25s ease;padding:14px 14px calc(18px + env(safe-area-inset-bottom));z-index:1000}
  .sheet.open{transform:translateY(0)}
  .sheet-backdrop{position:fixed;inset:0;background:#0008;opacity:0;pointer-events:none;transition:opacity .2s;z-index:900}
  .sheet-backdrop.show{opacity:1;pointer-events:auto}
  .sheet h3{margin:6px 0 10px;font-size:16px}
  .rowchips{display:flex;gap:8px;flex-wrap:wrap}
  .chipopt{background:#121212;border:1px solid var(--border);border-radius:999px;padding:8px 12px;font-size:13px;cursor:pointer}
  .chipopt.active{outline:2px solid var(--ring)}
  .inputline{display:flex;gap:8px;margin:10px 0}
  .inputline input{flex:1;background:#121212;border:1px solid var(--border);border-radius:10px;padding:10px;color:#fff;font-size:14px}
  .sheet .btnrow{display:flex;gap:10px;margin-top:10px}
  .sheet .btnrow .btnsm{flex:1;background:var(--green);border:none;border-radius:12px;color:#fff;padding:10px 0;font-weight:700}
  .sheet .btnrow .btnsm.cancel{background:#333}
  .btnsm[disabled]{ background:#333 !important; opacity:0.8; cursor:not-allowed; }
  .sheet p{color:#ddd;font-size:13px;line-height:1.35;margin:6px 0}

  #sheetChatFeed .feed{max-height:60vh;overflow:auto;display:flex;flex-direction:column;gap:8px}
  .msg{background:#121212;border:1px solid var(--border);border-radius:12px;padding:10px}
  .msg .meta{color:#aaa;font-size:12px;margin-bottom:4px}
  .msg .text{font-size:14px;line-height:1.3}


    @keyframes ringPulse{0%{transform:scale(1);}50%{transform:scale(1.02);}100%{transform:scale(1);}}
    .timer.pulse{animation:ringPulse 0.5s ease;}
    /* Shop sheet tabs */
    .tabs{display:flex;gap:8px;margin:6px 0 10px}
    .tab-btn{flex:1;background:#121212;border:1px solid var(--border);border-radius:10px;padding:8px 10px;font-size:13px;color:#fff;cursor:pointer}
    .tab-btn.active{outline:2px solid var(--ring)}
    .tab-pane{display:none}
    .tab-pane.show{display:block}
  </style>
</head>
<body>
<div class="wrap">
  <button class="back-text" id="backText">–ù–∞–∑–∞–¥</button>
  <div class="page-title">–ê—Ä–µ–Ω–∞</div>
  <div class="center">
    <div class="timer" id="timerWrap">
      <svg viewBox="0 0 320 320" preserveAspectRatio="xMidYMid meet">
        <circle cx="160" cy="160" r="140" stroke="#1f1f1f" stroke-width="14" fill="none"/>
        <circle id="ring" cx="160" cy="160" r="140" stroke="var(--ring)" stroke-width="14" fill="none" stroke-linecap="round" stroke-dasharray="879.645" stroke-dashoffset="0"/>
      </svg>
      <div class="inring-stack">
        <div class="inring-price" id="bank" data-v="0">$0</div>
        <div class="inring-bottom" id="ringStatus">00:00 ¬∑ –û–∂–∏–¥–∞–Ω–∏–µ —Å—Ç–∞–≤–∫–∏</div>
      </div>
    </div>
  </div>
  <button class="btn" id="bidBtn">–°—Ç–∞–≤–∫–∞ $0</button>
  <div class="head" id="leader">–õ–∏–¥–µ—Ä: ‚Äî</div>
  <div class="levelcard" id="levelCard">
    <div class="level-head">
      <div class="level-title">–£—Ä–æ–≤–µ–Ω—å <span id="lvlNum">1</span></div>
      <div class="level-balance">–ë–∞–ª–∞–Ω—Å: <span id="balInline">$‚Äî</span> ‚Ä¢ VOP: <span id="vopInline">‚Äî</span> üíé</div>
    </div>
    <div class="level-bar">
      <div class="level-fill" id="xpFill"></div>
    </div>
    <div class="level-xp" id="xpText">0 / 5 000 XP</div>
  </div>
  <div class="adline ad-shimmer" id="adLine">
    <div class="ad-left">
      <div class="ad-top">
        <span class="crown">üëë</span>
        <span class="ad-user" id="adUser">@user</span>
      </div>
      <div class="ad-text" id="adText">–°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è‚Ä¶</div>
    </div>
    <div class="ad-actions">
      <div class="ad-price" id="adPrice">–¶–µ–Ω–∞: $100</div>
      <button class="chipbtn ad-write" id="adWrite">‚úçÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å</button>
    </div>
  </div>
  <div class="menu">
    <button class="chipbtn" id="topupBtn">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</button>
    <button class="chipbtn" id="chatFeedBtn">–ß–ê–¢</button>
    <button class="chipbtn" id="rulesBtn">–ü—Ä–∞–≤–∏–ª–∞</button>
    <button class="chipbtn" id="starsBtn">–ö—É–ø–∏—Ç—å $</button>
    <button class="chipbtn" id="shopBtn">–ú–∞–≥–∞–∑–∏–Ω</button>
  </div>
  <div class="lb-head">–¢–æ–ø –∑–∞ 24 —á–∞—Å–∞</div>
  <div class="podium" id="lbPodium"></div>
  <div class="lb" id="lbRest"></div>
</div>
<div class="sheet-backdrop" id="sheetBg"></div>

<!-- SHEET: –ü—Ä–∞–≤–∏–ª–∞ -->
<div class="sheet" id="sheetRules">
  <h3>–ü—Ä–∞–≤–∏–ª–∞</h3>
  <p>–°–¥–µ–ª–∞–π —Å—Ç–∞–≤–∫—É –∏ —É–¥–µ—Ä–∂–∏–≤–∞–π –ª–∏–¥–µ—Ä—Å—Ç–≤–æ –¥–æ –∫–æ–Ω—Ü–∞ —Ç–∞–π–º–µ—Ä–∞.</p>
  <p>–ü–æ–±–µ–¥–∏—Ç–µ–ª—å –∑–∞–±–∏—Ä–∞–µ—Ç –≤–µ—Å—å –±–∞–Ω–∫.</p>
  <div class="btnrow"><button class="btnsm cancel" data-close>–ó–∞–∫—Ä—ã—Ç—å</button></div>
</div>

<!-- SHEET: –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ -->
<div class="sheet" id="sheetTopup">
  <h3>–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞</h3>
  <p>‚Ä¢ +$5000 ‚Äî –∑–∞ –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ –∫–∞–Ω–∞–ª @erc20coin (–æ–¥–∏–Ω —Ä–∞–∑)</p>
  <p>‚Ä¢ +$1000 ‚Äî –∑–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –≤—Ö–æ–¥</p>
  <p>‚Ä¢ +$500 ‚Äî –∑–∞ –∫–∞–∂–¥–æ–≥–æ –¥—Ä—É–≥–∞ –ø–æ —Ä–µ—Ñ-—Å—Å—ã–ª–∫–µ</p>
  <div class="btnrow">
    <button class="btnsm" id="openChannel">–û—Ç–∫—Ä—ã—Ç—å –∫–∞–Ω–∞–ª</button>
    <button class="btnsm" id="refBtn">+500$</button>
  </div>
  <div class="btnrow">
    <button class="btnsm cancel" data-close>–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<!-- SHEET: –ü–æ–∫—É–ø–∫–∞ Stars -->
<div class="sheet" id="sheetStars">
  <h3>–ö—É–ø–∏—Ç—å –∑–≤—ë–∑–¥—ã ‚≠ê</h3>
  <p>–í—ã–±–µ—Ä–∏ –ø–∞–∫–µ—Ç, –æ–ø–ª–∞—Ç–∏ –≤ Telegram Stars ‚Äî –±–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</p>
  <div class="rowchips" id="starsPacks">
    <button class="chipopt" data-pack="100">100‚≠ê ‚Üí $3 000</button>
    <button class="chipopt" data-pack="500">500‚≠ê ‚Üí $16 000</button>
    <button class="chipopt" data-pack="1000">1000‚≠ê ‚Üí $35 000</button>
    <button class="chipopt" data-pack="10000">10000‚≠ê ‚Üí $400 000</button>
    <button class="chipopt" data-pack="30000">30000‚≠ê ‚Üí $1 500 000</button>
  </div>
  <div class="btnrow">
    <button class="btnsm cancel" data-close>–û—Ç–º–µ–Ω–∞</button>
    <button class="btnsm" id="buyStars">–û–ø–ª–∞—Ç–∏—Ç—å</button>
  </div>
</div>

<!-- SHEET: –°–æ–æ–±—â–µ–Ω–∏–µ -->
<div class="sheet" id="sheetAd">
  <h3>–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</h3>
  <div class="inputline">
    <input id="adInput" type="text" maxlength="50" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ (–¥–æ 50 —Å–∏–º–≤–æ–ª–æ–≤)">
  </div>
  <div class="ad-info">
    <div class="ad-count" id="adCount">0/50</div>
    <div class="ad-enter" id="adEnter">–¶–µ–Ω–∞ —Å–µ–π—á–∞—Å: $100</div>
  </div>
  <div class="btnrow">
    <button class="btnsm cancel" data-close>–û—Ç–º–µ–Ω–∞</button>
    <button class="btnsm" id="adSend" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </div>
</div>

<!-- SHEET: –∏—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ -->
  <div class="sheet" id="sheetChatFeed">
    <h3>–∏—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞</h3>
    <div id="chatFeed" class="feed"></div>
    <div class="btnrow"><button class="btnsm cancel" data-close>–ó–∞–∫—Ä—ã—Ç—å</button></div>
  </div>

  <!-- SHEET: –ú–∞–≥–∞–∑–∏–Ω -->
  <div class="sheet" id="sheetShop">
    <h3>–ú–∞–≥–∞–∑–∏–Ω</h3>

    <div class="tabs" id="shopTabs">
      <button class="tab-btn active" data-tab="boosts">–ë—É—Å—Ç—ã</button>
      <button class="tab-btn" data-tab="cosm">–ö–æ—Å–º–µ—Ç–∏–∫–∞</button>
      <button class="tab-btn" data-tab="events">–°–æ–±—ã—Ç–∏—è</button>
      <button class="tab-btn" data-tab="clans">–ö–ª–∞–Ω—ã</button>
    </div>

    <div class="tab-pane show" id="tab-boosts">
      <p>–°–∫–æ—Ä–æ: x2 XP –Ω–∞ 30/60 –º–∏–Ω, –∫–æ–º–±–æ-–±—É—Å—Ç—ã, —Å–µ–∑–æ–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è.</p>
    </div>
    <div class="tab-pane" id="tab-cosm">
      <p>–°–∫–æ—Ä–æ: —Ä–∞–º–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è, —Ü–≤–µ—Ç –Ω–∏–∫–∞, —Å–∞–ª—é—Ç—ã –ø–æ–±–µ–¥.</p>
    </div>
    <div class="tab-pane" id="tab-events">
      <p>–°–∫–æ—Ä–æ: –º–∏–Ω–∏-—Ç—É—Ä–Ω–∏—Ä—ã, –¥–∂–µ–∫–ø–æ—Ç—ã –Ω–µ–¥–µ–ª–∏, –º–∞—Ä–∞—Ñ–æ–Ω—ã.</p>
    </div>
    <div class="tab-pane" id="tab-clans">
      <p>–°–∫–æ—Ä–æ: –∫–ª–∞–Ω—ã, –∫–ª–∞–Ω–æ–≤—ã–µ –±—É—Å—Ç—ã –∏ —Ä–µ–π—Ç–∏–Ω–≥–∏.</p>
    </div>

    <div class="btnrow">
      <button class="btnsm cancel" data-close>–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>

<script>
const BOT_USERNAME = 'realpricebtc_bot';
const CHANNEL_LINK = 'https://t.me/erc20coin';
const tg = window.Telegram?.WebApp; tg?.expand();
const uid = tg?.initDataUnsafe?.user?.id || null;
const username = tg?.initDataUnsafe?.user?.username ? '@'+tg.initDataUnsafe.user.username : null;

if (window.Telegram?.WebApp?.BackButton) {
  Telegram.WebApp.BackButton.show();
  Telegram.WebApp.onEvent('backButtonClicked', () => { window.location.href = '/'; });
}

const ring = document.getElementById('ring');
const timerWrap = document.getElementById('timerWrap');
const bankEl = document.getElementById('bank');
const ringStatus = document.getElementById('ringStatus');
const backText = document.getElementById('backText');
const lbPodium = document.getElementById('lbPodium');
const lbRest = document.getElementById('lbRest');
backText.onclick = () => { window.location.href = '/'; };
const bidBtn = document.getElementById('bidBtn');
const leaderEl = document.getElementById('leader');
const lvlNum = document.getElementById('lvlNum');
const balInline = document.getElementById('balInline');
const vopInline = document.getElementById('vopInline');
const xpFill = document.getElementById('xpFill');
const xpText = document.getElementById('xpText');

const adLine = document.getElementById('adLine');
const adUserEl = document.getElementById('adUser');
const adTextEl = document.getElementById('adText');
const adPriceEl = document.getElementById('adPrice');
const adWriteBtn = document.getElementById('adWrite');

const refBtn = document.getElementById('refBtn');
const topupBtn = document.getElementById('topupBtn');
const chatFeedBtn = document.getElementById('chatFeedBtn');
const rulesBtn = document.getElementById('rulesBtn');
const starsBtn = document.getElementById('starsBtn');
const shopBtn = document.getElementById('shopBtn');

const sheetBg = document.getElementById('sheetBg');
const sheetRules = document.getElementById('sheetRules');
const sheetTopup = document.getElementById('sheetTopup');
const sheetStars = document.getElementById('sheetStars');
const sheetAd = document.getElementById('sheetAd');
const sheetChatFeed = document.getElementById('sheetChatFeed');
const sheetShop = document.getElementById('sheetShop');
const shopTabs = document.getElementById('shopTabs');

const openChannel = document.getElementById('openChannel');
const starsPacks = document.getElementById('starsPacks');
const buyStars = document.getElementById('buyStars');
const adInput = document.getElementById('adInput');
const adSend = document.getElementById('adSend');
const adCount = document.getElementById('adCount');
const adEnter = document.getElementById('adEnter');
const chatFeed = document.getElementById('chatFeed');

let selectedPack = null;
let arenaPhase = 'idle';
let arenaMax = 0;
let pauseMax = 0;
let adState = {};

function fmt(n){ return '$'+Number(n||0).toLocaleString(); }
function normUser(u){ return '@'+String(u||'anon').replace(/^@+/, ''); }
function setBalanceVal(amount, vop){
  if(balInline) balInline.textContent = fmt(amount);
  if(vopInline) vopInline.textContent = Number(vop||0).toLocaleString('ru-RU');
}
function renderProfile(p){
  if(!p) return;
  lvlNum.textContent = p.level;
  const prog = Math.max(0, Math.min(1, (p.level_progress||0)/(p.level_threshold||1)));
  xpFill.style.width = (prog*100).toFixed(1)+'%';
  xpText.textContent = `${Number(p.level_progress||0).toLocaleString()} / ${Number(p.level_threshold||0).toLocaleString()} XP`;
  setBalanceVal(p.balance, p.vop_balance);
}
async function loadProfile(){
  if(!uid) return;
  const r = await fetch('/api/auth',{method:'POST',headers:{'Content-Type':'application/json'},body: JSON.stringify({ uid })}).then(r=>r.json()).catch(()=>null);
  if(r?.ok) renderProfile(r.user);
}
function showBigBanner(text,color){
  const div=document.createElement('div');
  div.textContent=text;
  div.style.position='fixed';
  div.style.left='50%';div.style.top='40%';div.style.transform='translate(-50%,-50%)';
  div.style.background=color==='green'?'#1fa36a':'#c6423a';
  div.style.color='#fff';div.style.padding='20px 30px';div.style.fontSize='32px';div.style.fontWeight='800';div.style.borderRadius='16px';div.style.zIndex='999';
  document.body.appendChild(div);
  setTimeout(()=>div.remove(),1500);
}
function renderArena(st){
  const newBank = Number(st.bank||0);
  bankEl.textContent = fmt(newBank);
  bankEl.dataset.v = newBank;
  const mm = Math.floor(st.secsLeft/60);
  const ss = st.secsLeft % 60;
  const statusTxt = st.phase==='idle'?'–û–∂–∏–¥–∞–Ω–∏–µ —Å—Ç–∞–≤–∫–∏':st.phase==='pause'?'–ü–∞—É–∑–∞':'–ò–¥—ë—Ç –∞—É–∫—Ü–∏–æ–Ω';
  ringStatus.textContent = `${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')} ¬∑ ${statusTxt}`;
  bidBtn.textContent = '–°—Ç–∞–≤–∫–∞ $' + Number(st.nextBid||0).toLocaleString();
  bidBtn.disabled = st.phase === 'pause';
  leaderEl.textContent = '–õ–∏–¥–µ—Ä: ' + (st.leader?.name ? normUser(st.leader.name) : '‚Äî');

  if(arenaPhase!==st.phase){
    if(st.phase==='betting') arenaMax = st.secsLeft;
    if(st.phase==='pause') pauseMax = st.secsLeft;
  } else {
    if(st.phase==='betting' && st.secsLeft>arenaMax) arenaMax = st.secsLeft;
    if(st.phase==='pause' && st.secsLeft>pauseMax) pauseMax = st.secsLeft;
  }

  const pct = st.phase==='betting' ? (arenaMax? st.secsLeft/arenaMax : 0)
             : st.phase==='pause' ? (pauseMax? st.secsLeft/pauseMax : 0)
             : 0;
  const CIRC = 2*Math.PI*140; ring.setAttribute('stroke-dasharray', CIRC); ring.setAttribute('stroke-dashoffset', CIRC*(1-pct));
  if(arenaPhase!=='pause' && st.phase==='pause' && st.lastWinnerTid && uid){
    if(st.lastWinnerTid===uid){
      showBigBanner('YOU WON!','green');
      try{ tg?.HapticFeedback?.notificationOccurred('success'); navigator?.vibrate?.(70); }catch{}
    }else{
      showBigBanner('YOU LOSE!','red');
      try{ tg?.HapticFeedback?.notificationOccurred('error'); navigator?.vibrate?.([80,100,80]); }catch{}
    }
  }
  arenaPhase = st.phase;
}
async function pollArena(){
  const r = await fetch('/api/arena/state').then(r=>r.json()).catch(()=>null);
  if(r?.ok) renderArena(r);
}
async function pollAd(){
  const r = await fetch('/api/shout').then(r=>r.json()).catch(()=>null);
  if(!r?.ok) return;
  const st = r.state||{};
  adState = st;
  adUserEl.textContent = normUser(st.holder?.name);
  adTextEl.textContent = st.message || '–ü–æ–∫–∞ –ø—É—Å—Ç–æ.';
  adPriceEl.textContent = '–¶–µ–Ω–∞: $' + Number(st.next_price||0).toLocaleString();
  adEnter.textContent = '–¶–µ–Ω–∞ —Å–µ–π—á–∞—Å: $' + Number(st.next_price||0).toLocaleString();
}
async function loadChatHistory(){
  const r = await fetch('/api/shout/history?limit=50').then(r=>r.json()).catch(()=>({ok:false,items:[]}));
  if(!r.ok){ chatFeed.innerHTML = '<div class="msg"><div class="text">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å.</div></div>'; return; }
  chatFeed.innerHTML = r.items.map(it=>(
    `<div class="msg"><div class="meta">${normUser(it.username)} ¬∑ $${Number(it.price||0).toLocaleString()} ¬∑ ${new Date(it.created_at).toLocaleTimeString().slice(0,5)}</div><div class="text">${escapeHtml(it.text||'')}</div></div>`
  )).join('');
}
function escapeHtml(s){return String(s).replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));}
function openSheet(el){ if(!el) return; sheetBg.classList.add('show'); el.classList.add('open'); }
function closeAllSheets(){ document.querySelectorAll('.sheet.open').forEach(s=>s.classList.remove('open')); sheetBg.classList.remove('show'); }
sheetBg.addEventListener('click', closeAllSheets);
document.querySelectorAll('[data-close]').forEach(b=>b.addEventListener('click', closeAllSheets));

bidBtn.addEventListener('click', async ()=>{
  if(bidBtn.disabled) return;
  const oldBank = Number(bankEl.dataset.v||0);
  const r = await fetch('/api/arena/bid',{method:'POST',headers:{'Content-Type':'application/json'},body: JSON.stringify({ initData: tg?.initData || '' })}).then(r=>r.json()).catch(()=>null);
  if(r?.ok){
    animateBank(oldBank, r.bank);
    renderArena(r);
    loadProfile();
    try{ tg?.HapticFeedback?.impactOccurred('soft'); navigator?.vibrate?.(15); }catch{}
  } else if(r?.error==='INSUFFICIENT'){ alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤'); }
});
function animateBank(from,to){
  const start = performance.now();
  function step(ts){
    const p = Math.min(1,(ts-start)/400);
    const val = from + (to-from)*p;
    bankEl.textContent = fmt(val);
    if(p<1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
  timerWrap.classList.add('pulse');
  timerWrap.addEventListener('animationend',()=>timerWrap.classList.remove('pulse'),{once:true});
}

refBtn.onclick = ()=>{
  const link = `https://t.me/${BOT_USERNAME}?start=${uid}`;
  if(navigator.share){ navigator.share({ title:'BTC Game', text:'–ó–∞–ª–µ—Ç–∞–π –≤ –∏–≥—Ä—É!', url:link }).catch(()=>{}); }
  else { alert('–¢–≤–æ—è —Ä–µ—Ñ-—Å—Å—ã–ª–∫–∞:\n'+link+'\n–ó–∞ –∫–∞–∂–¥–æ–≥–æ –¥—Ä—É–≥–∞ +$500 –ø–æ—Å–ª–µ –µ–≥–æ –ø–µ—Ä–≤–æ–≥–æ –≤—Ö–æ–¥–∞.'); }
};

topupBtn.onclick = ()=> openSheet(sheetTopup);
chatFeedBtn.onclick = async ()=>{ await loadChatHistory(); openSheet(sheetChatFeed); };
rulesBtn.onclick = ()=> openSheet(sheetRules);
starsBtn.onclick = ()=> openSheet(sheetStars);
shopBtn.onclick = ()=> openSheet(sheetShop);
adWriteBtn.onclick = ()=>{ adInput.value=''; adCount.textContent='0/50'; adSend.disabled=true; openSheet(sheetAd); };

adInput.addEventListener('input', ()=>{
  const v = adInput.value.slice(0,50);
  adInput.value = v;
  adCount.textContent = v.length+'/50';
  adSend.disabled = !v.trim();
});

adSend.onclick = async ()=>{
  const text = adInput.value.trim();
  if(!text) return;
  const r = await fetch('/api/shout/bid',{method:'POST',headers:{'Content-Type':'application/json'},body: JSON.stringify({ initData: tg?.initData || '', text })}).then(r=>r.json()).catch(()=>({ok:false}));
  if(r.ok){ closeAllSheets(); pollAd(); loadProfile(); }
  else if(r.error==='INSUFFICIENT'){ alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤'); }
};
shopTabs.addEventListener('click', (e)=>{
  const b = e.target.closest('.tab-btn'); if(!b) return;
  shopTabs.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  const tab = b.dataset.tab;
  sheetShop.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('show'));
  sheetShop.querySelector(`#tab-${tab}`)?.classList.add('show');
});

async function loadLb24(){
  const r = await fetch('/api/arena/leaderboard?window=24h').then(r=>r.json()).catch(()=>null);
  if(!r?.ok) return;
  const items = r.items || [];
  const top3 = items.slice(0,3);
  lbPodium.innerHTML = top3.map((it,i)=>`
    <div class="pod pod${i+1}">
      <div class="name">${normUser(it.username)}</div>
      <div class="wins">${it.wins} –ø–æ–±–µ–¥</div>
      <div class="sum">${fmt(it.total_won)}</div>
    </div>`).join('');
  lbRest.innerHTML = items.slice(3).map((it,i)=>`
    <div class="rank">
      <div class="left">
        <div class="badge">${i+4}</div>
        <div class="name">${normUser(it.username)}<span class="wins">(${it.wins})</span></div>
      </div>
      <div class="val">${fmt(it.total_won)}</div>
    </div>`).join('');
}

openChannel.onclick = ()=>{ try{ if(window.Telegram?.WebApp?.openTelegramLink) Telegram.WebApp.openTelegramLink(CHANNEL_LINK); else window.open(CHANNEL_LINK); }catch{ window.open(CHANNEL_LINK); } };

starsPacks.addEventListener('click', e=>{
  const b = e.target.closest('.chipopt'); if(!b) return;
  document.querySelectorAll('#starsPacks .chipopt').forEach(x=>x.classList.remove('active'));
  b.classList.add('active'); selectedPack = b.dataset.pack;
});
buyStars.onclick = async ()=>{
  const pack = selectedPack || '100';
  const resp = await fetch('/api/stars/create',{method:'POST',headers:{'Content-Type':'application/json'},body: JSON.stringify({ pack, initData: tg?.initData || '' })}).then(r=>r.json()).catch(()=>({ok:false}));
  if(!resp.ok){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç—ë–∂.'); return; }
  Telegram?.WebApp?.openInvoice?.(resp.link, async status => { if(status==='paid'){ await loadProfile(); } });
};

setInterval(pollArena,1000);
setInterval(pollAd,4000);
setInterval(loadProfile,5000);
setInterval(loadLb24,25000);
loadProfile();
pollArena();
pollAd();
loadLb24();
</script>

</body>
</html>
